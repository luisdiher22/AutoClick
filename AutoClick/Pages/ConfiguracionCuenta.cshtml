@page
@model AutoClick.Pages.ConfiguracionCuentaModel
@{
    ViewData["Title"] = "Configuración de cuenta - AutoClick.cr";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/configuracion-cuenta.css" />
    <link rel="stylesheet" href="~/css/configuracion-cuenta-responsive.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        /* Personalización de SweetAlert2 estilo AnunciarEmpresa */
        .swal2-popup {
            background: #030D2B !important;
            border-radius: 12px !important;
            padding: 32px 24px 24px 24px !important;
        }
        
        .swal2-title {
            color: white !important;
            font-family: 'Montserrat', sans-serif !important;
            font-weight: 700 !important;
            font-size: 24px !important;
            margin-bottom: 20px !important;
        }
        
        .swal2-html-container {
            color: rgba(255, 255, 255, 0.8) !important;
            font-family: 'Montserrat', sans-serif !important;
            font-weight: 400 !important;
            font-size: 16px !important;
            margin-bottom: 24px !important;
        }
        
        .swal2-confirm {
            background: #0A2680 !important;
            border-radius: 4px !important;
            border: 0.5px solid white !important;
            color: white !important;
            font-family: 'Montserrat', sans-serif !important;
            font-weight: 700 !important;
            font-size: 16px !important;
            padding: 12px 24px !important;
            transition: all 0.3s ease !important;
        }
        
        .swal2-confirm:hover {
            background: #0d2e99 !important;
            transform: translateY(-1px) !important;
        }
        
        .swal2-cancel {
            background: transparent !important;
            border: 0.5px solid rgba(255, 255, 255, 0.5) !important;
            color: white !important;
            font-family: 'Montserrat', sans-serif !important;
            font-weight: 500 !important;
            font-size: 16px !important;
            padding: 12px 24px !important;
            border-radius: 4px !important;
            transition: all 0.3s ease !important;
        }
        
        .swal2-cancel:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }
    </style>
}

<!-- Floating Sidebar Toggle Button (Mobile & Tablet only) -->
<button class="profile-sidebar-toggle" onclick="toggleProfileSidebar()" aria-label="Abrir menú">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>

<!-- Overlay for sidebar -->
<div class="profile-sidebar-overlay" onclick="closeProfileSidebar()"></div>

<!-- Floating Sidebar Menu (Mobile & Tablet only) -->
<aside class="profile-sidebar-floating">
    <div class="profile-sidebar-floating-header">
        <h3 class="profile-sidebar-floating-title">Menú de perfil</h3>
        <button class="profile-sidebar-close" onclick="closeProfileSidebar()">&times;</button>
    </div>
    <nav class="sidebar-nav">
        <a href="/MiPerfil" class="nav-item">
            <span>Información personal</span>
        </a>
        <a href="/HistorialPagos" class="nav-item">
            <span>Historial de pagos</span>
        </a>
        <a href="/ConfiguracionCuenta" class="nav-item active">
            <span>Configuración de cuenta</span>
        </a>
    </nav>
</aside>

<div class="page-wrapper">
    <div class="configuracion-cuenta-container">
    <!-- Sidebar -->
    <div class="account-sidebar">
        <div class="sidebar-nav">
            <a href="/MiPerfil" class="nav-item">
                <div class="personal-icon"></div>
                <span>Información de contacto</span>
            </a>
            <a href="/HistorialPagos" class="nav-item">
                <div class="payments-icon"></div>
                <span>Historial de pagos</span>
            </a>
            <a href="/ConfiguracionCuenta" class="nav-item active">
                <div class="settings-icon"></div>
                <span>Configuración de cuenta</span>
            </a>
        </div>
        <div class="sidebar-indicator"></div>
    </div>

    <!-- Main Content -->
    <div class="account-content">
        <div class="page-header">
            <h1 class="page-title">Configuración de cuenta</h1>
        </div>

        <!-- Success/Error Messages -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">
                @TempData["SuccessMessage"]
            </div>
        }
        
        @if (TempData["AccountDeleted"] != null)
        {
            <div class="alert alert-info">
                @TempData["AccountDeleted"]
            </div>
        }

        <!-- Account Settings Form -->
        <form method="post" class="account-form" asp-page-handler="UpdateAccount">
            
            <!-- Email Section -->
            <div class="form-section">
                <div class="form-group">
                    <label for="Email">Correo electrónico</label>
                    <input asp-for="Email" type="email" class="form-input" readonly />
                    <div class="form-actions">
                        <button type="button" class="change-email-btn" onclick="showChangeEmail()">
                            Cambiar correo electrónico
                        </button>
                    </div>
                </div>
            </div>

            <!-- Password Section -->
            <div class="form-section">
                <div class="form-group">
                    <label for="CurrentPassword">Contraseña</label>
                    <input type="password" class="form-input" value="********************" readonly />
                    <div class="form-actions">
                        <button type="button" class="forgot-password-btn" onclick="showForgotPassword()">
                            ¿Olvidó su contraseña?
                        </button>
                        <button type="button" class="change-password-btn" onclick="showChangePassword()">
                            Deseo cambiar mi contraseña
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delete Account Section -->
            <div class="danger-section">
                <button type="button" class="delete-account-btn" onclick="showDeleteAccountModal()">
                    <svg width="17" height="19" viewBox="0 0 17 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.25 16.5C2.25 17.742 3.25725 18.75 4.5 18.75H12C13.242 18.75 14.25 17.742 14.25 16.5L15.75 4.5H0.75L2.25 16.5ZM10.5 6.75H12V16.5H10.5V6.75ZM7.5 6.75H9V16.5H7.5V6.75ZM4.5 6.75H6V16.5H4.5V6.75ZM15.375 1.5H10.5C10.5 1.5 10.164 0 9.75 0H6.75C6.33525 0 6 1.5 6 1.5H1.125C0.50325 1.5 0 2.00325 0 2.625C0 3.24675 0 3.75 0 3.75H16.5C16.5 3.75 16.5 3.24675 16.5 2.625C16.5 2.00325 15.996 1.5 15.375 1.5Z" fill="white"/>
                    </svg>
                    Eliminar cuenta
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Change Email Modal -->
<div id="changeEmailModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cambiar correo electrónico</h3>
            <button type="button" class="modal-close" onclick="closeModal('changeEmailModal')">&times;</button>
        </div>
        <form method="post" asp-page-handler="ChangeEmail" class="modal-form">
            <div class="form-group">
                <label for="CurrentEmailForChange">Correo electrónico actual</label>
                <input asp-for="CurrentEmailForChange" type="email" class="form-input" required autocomplete="off" />
                <span asp-validation-for="CurrentEmailForChange" class="validation-message"></span>
            </div>
            <div class="form-group">
                <label for="CurrentPasswordForEmail">Contraseña actual</label>
                <input asp-for="CurrentPasswordForEmail" type="password" class="form-input" required autocomplete="new-password" />
                <span asp-validation-for="CurrentPasswordForEmail" class="validation-message"></span>
            </div>
            <div class="form-group">
                <label for="NewEmail">Nuevo correo electrónico (@@gmail.com)</label>
                <input asp-for="NewEmail" type="email" class="form-input" required autocomplete="off" placeholder="ejemplo@gmail.com" />
                <span asp-validation-for="NewEmail" class="validation-message"></span>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">Cambiar correo</button>
                <button type="button" class="btn-secondary" onclick="closeModal('changeEmailModal')">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cambiar contraseña</h3>
            <button type="button" class="modal-close" onclick="closeModal('changePasswordModal')">&times;</button>
        </div>
        <form method="post" asp-page-handler="ChangePassword" class="modal-form">
            <div class="form-group">
                <label for="CurrentPassword">Contraseña actual</label>
                <input asp-for="CurrentPassword" type="password" class="form-input" required autocomplete="new-password" />
                <span asp-validation-for="CurrentPassword" class="validation-message"></span>
            </div>
            <div class="form-group">
                <label for="NewPassword">Nueva contraseña</label>
                <input asp-for="NewPassword" type="password" class="form-input" required autocomplete="new-password" />
                <span asp-validation-for="NewPassword" class="validation-message"></span>
            </div>
            <div class="form-group">
                <label for="ConfirmPassword">Confirmar nueva contraseña</label>
                <input asp-for="ConfirmPassword" type="password" class="form-input" required autocomplete="new-password" />
                <span asp-validation-for="ConfirmPassword" class="validation-message"></span>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">Cambiar contraseña</button>
                <button type="button" class="btn-secondary" onclick="closeModal('changePasswordModal')">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- Forgot Password Modal -->
<div id="forgotPasswordModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Recuperar contraseña</h3>
            <button type="button" class="modal-close" onclick="closeModal('forgotPasswordModal')">&times;</button>
        </div>
        <form method="post" asp-page-handler="ForgotPassword" class="modal-form">
            <p class="modal-description">
                Te enviaremos un enlace para restablecer tu contraseña a tu correo electrónico.
            </p>
            <div class="form-group">
                <label for="ForgotPasswordEmail">Correo electrónico</label>
                <input asp-for="ForgotPasswordEmail" type="email" class="form-input" required />
                <span asp-validation-for="ForgotPasswordEmail" class="validation-message"></span>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">Enviar enlace</button>
                <button type="button" class="btn-secondary" onclick="closeModal('forgotPasswordModal')">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Account Modal -->
<div id="deleteAccountModal" class="modal-overlay" style="display: none;">
    <div class="modal-content danger-modal">
        <div class="modal-header">
            <h3>Eliminar cuenta</h3>
            <button type="button" class="modal-close" onclick="closeModal('deleteAccountModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p class="danger-warning">
                <strong>¡ADVERTENCIA!</strong> Esta acción no se puede deshacer.
            </p>
            <p class="modal-description">
                Al eliminar tu cuenta, perderás todos tus datos, anuncios y configuraciones de forma permanente.
            </p>
            <form method="post" asp-page-handler="DeleteAccount" class="modal-form">
                <div class="form-group">
                    <label for="DeleteConfirmPassword">Para confirmar, ingresa tu contraseña:</label>
                    <input asp-for="DeleteConfirmPassword" type="password" class="form-input" required />
                    <span asp-validation-for="DeleteConfirmPassword" class="validation-message"></span>
                </div>
                <div class="checkbox-group">
                    <input asp-for="ConfirmDeletion" type="checkbox" id="confirmDeletion" required />
                    <label for="confirmDeletion">Entiendo que esta acción es irreversible</label>
                </div>
                <div class="modal-actions modal-actions-stacked">
                    <button type="submit" class="btn-danger btn-full-width">Eliminar cuenta permanentemente</button>
                    <button type="button" class="btn-secondary btn-full-width" onclick="closeModal('deleteAccountModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/profile-sidebar.js"></script>
    <script src="~/js/configuracion-cuenta.js"></script>
    
    <script>
        // Mostrar mensajes de error si hay errores de validación
        @if (!ViewData.ModelState.IsValid && ViewData.ModelState.ErrorCount > 0)
        {
            var errors = ViewData.ModelState
                .Where(kvp => kvp.Value.Errors.Count > 0)
                .SelectMany(kvp => kvp.Value.Errors.Select(e => new { Field = kvp.Key, Message = e.ErrorMessage }))
                .Where(e => !string.IsNullOrEmpty(e.Message))
                .ToList();
            
            if (errors.Any())
            {
                var errorMessages = string.Join("<br>", errors.Select(e => $"• {e.Message}"));
                <text>
                Swal.fire({
                    icon: 'error',
                    title: 'Error de validación',
                    html: '@Html.Raw(errorMessages)',
                    confirmButtonColor: '#4A90E2',
                    confirmButtonText: 'Entendido'
                }).then(() => {
                    // Reabrir el modal correspondiente si hay error específico
                    @foreach (var error in errors)
                    {
                        if (error.Field.Contains("Email") || error.Field.Contains("CurrentEmailForChange"))
                        {
                            <text>showChangeEmail();</text>
                            break;
                        }
                        else if (error.Field.Contains("Password") && !error.Field.Contains("Delete"))
                        {
                            <text>showChangePassword();</text>
                            break;
                        }
                        else if (error.Field.Contains("Delete"))
                        {
                            <text>showDeleteAccountModal();</text>
                            break;
                        }
                    }
                });
                </text>
            }
        }
        
        // Mostrar mensaje de éxito si existe
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: '@TempData["SuccessMessage"]',
                confirmButtonColor: '#4A90E2',
                timer: 3000,
                showConfirmButton: true
            });
            </text>
        }
        
        // Log para debugging
        console.log('ConfiguracionCuenta: Script cargado correctamente');
    </script>
}

