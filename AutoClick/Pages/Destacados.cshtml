@page "/destacados"
@model DestacadosModel
@{
    ViewData["Title"] = "Destacados - AutoClick.cr";
}

@section Styles {
    <link rel="stylesheet" href="~/css/destacados-responsive.css" asp-append-version="true" />
}

<!-- Dark Theme Page Container -->
<div class="busqueda-avanzada-page">
    <div class="busqueda-container">
        <!-- Breadcrumb Navigation -->
        <nav class="busqueda-breadcrumb">
            <a asp-page="/Index" class="breadcrumb-link">Inicio</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">Destacados</span>
        </nav>

        <div class="busqueda-content">
            <!-- Sidebar Filters -->
            <aside class="busqueda-sidebar">
                <!-- Filter Container -->
                <div class="busqueda-filters-container">
                    <div class="busqueda-filters-section">
                        <!-- Filters Header -->
                        <h3 class="busqueda-filters-title">Filtros de búsqueda</h3>
                        
                        <!-- Applied Filters Tags -->
                        @if (Model.AppliedFilters.Any())
                        {
                            <div class="applied-filters-tags">
                                @foreach (var filter in Model.AppliedFilters)
                                {
                                    <div class="filter-tag">
                                        <span>@filter</span>
                                        <button class="remove-filter-btn" onclick="removeFilter('@filter')" title="Eliminar filtro">×</button>
                                    </div>
                                }
                            </div>
                            
                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />
                        }

                        <!-- Filter Form -->
                        <form method="get" class="busqueda-filters-form">
                            <input type="hidden" name="page" value="1" />
                            <input type="hidden" name="sortBy" value="@Model.SortBy" />

                            <!-- Provincia -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Provincia</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="province" class="busqueda-filter-select" id="province-select" onchange="onProvinceChange()">
                                        <option value="">Todas las provincias</option>
                                        @foreach (var province in Model.AvailableProvinces)
                                        {
                                            <option value="@province" selected="@(Model.Province == province)">@province</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Cantón -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Cantón</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="canton" class="busqueda-filter-select" id="canton-select">
                                        <option value="">Todos los cantones</option>
                                        @foreach (var canton in Model.AvailableCantons)
                                        {
                                            <option value="@canton" selected="@(Model.Canton == canton)">@canton</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Marca -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Marca</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="brand" class="busqueda-filter-select" id="brand-select" onchange="onBrandChange()">
                                        <option value="">Todas las marcas</option>
                                        @foreach (var brand in Model.AvailableBrands)
                                        {
                                            <option value="@brand" selected="@(Model.Brand == brand)">@brand</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Modelo -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Modelo</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="model" class="busqueda-filter-select" id="model-select">
                                        <option value="">Todos los modelos</option>
                                        @foreach (var modelName in Model.AvailableModels)
                                        {
                                            <option value="@modelName" selected="@(Model.Model == modelName)">@modelName</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Rango de precio -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Rango de precio</label>
                                <div class="busqueda-price-range">
                                    <div class="price-input-group">
                                        <label class="price-input-label">Min</label>
                                        <input type="number" name="minPrice" placeholder="$" class="busqueda-price-field" value="@Model.MinPrice" />
                                    </div>
                                    <span class="price-separator">hasta</span>
                                    <div class="price-input-group">
                                        <label class="price-input-label">Max</label>
                                        <input type="number" name="maxPrice" placeholder="$" class="busqueda-price-field" value="@Model.MaxPrice" />
                                    </div>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Kilometraje -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Kilometraje</label>
                                <div class="busqueda-price-range">
                                    <div class="price-input-group">
                                        <label class="price-input-label">Min</label>
                                        <input type="number" name="minKm" class="busqueda-price-field" value="@Model.MinKm" />
                                    </div>
                                    <span class="price-separator">hasta</span>
                                    <div class="price-input-group">
                                        <label class="price-input-label">Max</label>
                                        <input type="number" name="maxKm" class="busqueda-price-field" value="@Model.MaxKm" />
                                    </div>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Año -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Año</label>
                                <div class="busqueda-price-range">
                                    <div class="price-input-group">
                                        <label class="price-input-label">Min</label>
                                        <div class="busqueda-select-wrapper">
                                            <select name="minYear" class="busqueda-filter-select small">
                                                <option value="">Cualquiera</option>
                                                @foreach (var year in Model.AvailableYears)
                                                {
                                                    <option value="@year" selected="@(Model.MinYear == year)">@year</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <span class="price-separator">hasta</span>
                                    <div class="price-input-group">
                                        <label class="price-input-label">Max</label>
                                        <div class="busqueda-select-wrapper">
                                            <select name="maxYear" class="busqueda-filter-select small">
                                                <option value="">Cualquiera</option>
                                                @foreach (var year in Model.AvailableYears)
                                                {
                                                    <option value="@year" selected="@(Model.MaxYear == year)">@year</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Additional Filters -->
                            <!-- Carrocería -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Carrocería</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="bodyType" class="busqueda-filter-select">
                                        <option value="">Todas las carrocerías</option>
                                        @foreach (var bodyType in Model.AvailableBodyTypes)
                                        {
                                            <option value="@bodyType" selected="@(Model.BodyType == bodyType)">@bodyType</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Combustible -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Combustible/Propulsión</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="fuelType" class="busqueda-filter-select">
                                        <option value="">Todos los combustibles</option>
                                        @foreach (var fuelType in Model.AvailableFuelTypes)
                                        {
                                            <option value="@fuelType" selected="@(Model.FuelType == fuelType)">@fuelType</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Transmisión -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Transmisión</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="transmission" class="busqueda-filter-select">
                                        <option value="">Todas las transmisiones</option>
                                        @foreach (var transmission in Model.AvailableTransmissions)
                                        {
                                            <option value="@transmission" selected="@(Model.Transmission == transmission)">@transmission</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Condición -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Condición</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="condition" class="busqueda-filter-select">
                                        <option value="">Todas las condiciones</option>
                                        @foreach (var condition in Model.AvailableConditions)
                                        {
                                            <option value="@condition" selected="@(Model.Condition == condition)">@condition</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Sidebar Advertisement -->
                <div style="margin-top: 24px;">
                    @await Component.InvokeAsync("CarruselPublicidad", new { formato = "cuadrado", seccion = "destacados-sidebar" })
                </div>
            </aside>

            <!-- Main Content -->
            <main class="busqueda-main">
                <!-- Sort Dropdown -->
                <div class="busqueda-sort-header">
                    <!-- Mobile/Tablet Filter Button -->
                    <button class="busqueda-filter-btn-mobile" onclick="openFilterModal()">
                        <!-- Icono Figma: controles verticales (estilo sliders) -->
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                            <g stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
                                <!-- Línea izquierda + círculo -->
                                <path d="M4.5 3V15"/>
                                <circle cx="4.5" cy="6.5" r="1.6" fill="currentColor"/>
                                <!-- Línea centro + círculo -->
                                <path d="M9 3V15"/>
                                <circle cx="9" cy="11.5" r="1.6" fill="currentColor"/>
                                <!-- Línea derecha + círculo -->
                                <path d="M13.5 3V15"/>
                                <circle cx="13.5" cy="8.5" r="1.6" fill="currentColor"/>
                            </g>
                        </svg>
                        Filtros
                    </button>

                    <div class="busqueda-sort-wrapper">
                        <select class="busqueda-sort-select" onchange="changeBusquedaSorting(this.value)">
                            <option value="recent" selected="@(Model.SortBy == "recent")">Ordenar por: Más recientes</option>
                            <option value="price-asc" selected="@(Model.SortBy == "price-asc")">Ordenar por: Precio menor a mayor</option>
                            <option value="price-desc" selected="@(Model.SortBy == "price-desc")">Ordenar por: Precio mayor a menor</option>
                            <option value="year" selected="@(Model.SortBy == "year")">Ordenar por: Año más nuevo</option>
                        </select>
                    </div>
                </div>

                <!-- Cars Grid - 2 Columns -->
                <div class="busqueda-cars-grid">
                    @foreach (var auto in Model.Autos)
                    {
                        <div class="busqueda-auto-card">
                            <!-- Banderín superior derecho (fuera del link) -->
                            @if (!string.IsNullOrEmpty(auto.BanderinVideoUrl))
                            {
                                <div class="busqueda-banderin-container">
                                    @if (auto.BanderinVideoUrl.EndsWith(".gif", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <img src="@auto.BanderinVideoUrl" alt="Banderín" />
                                    }
                                    else
                                    {
                                        <video autoplay loop muted playsinline>
                                            <source src="@auto.BanderinVideoUrl" type="video/mp4">
                                        </video>
                                    }
                                </div>
                            }
                            
                            <a asp-page="/Producto" asp-route-id="@auto.Id" class="busqueda-auto-card-link">
                                <!-- Car Image -->
                                <div class="busqueda-auto-card-image">
                                    <img src="@auto.ImagenPrincipal" alt="@auto.NombreCompleto" />
                                </div>

                                <!-- Car Info Container with dark background -->
                                <div class="busqueda-auto-card-info">
                                    <!-- Top row: Title only -->
                                    <div class="busqueda-auto-card-row-top">
                                        <div class="busqueda-auto-card-title">@auto.NombreCompleto</div>
                                    </div>
                                    
                                    <!-- Middle row: Price on left, KM + Cuota on right -->
                                    <div class="busqueda-auto-card-row-middle">
                                        <div class="busqueda-auto-card-price">@auto.PrecioEnCRC</div>
                                        <div class="busqueda-auto-card-right-info">
                                            <div class="busqueda-auto-card-km">@auto.Kilometraje km</div>
                                            <div class="busqueda-auto-card-cuota">Est. ₡@((auto.Precio * 0.015m).ToString("N0"))/mes</div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                            
                            <!-- Botón de Favoritos fuera del link -->
                            <button class="busqueda-favorite-btn favorite-btn" 
                                    data-auto-id="@auto.Id" 
                                    data-email-usuario="@(User.Identity?.IsAuthenticated == true ? User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? User.FindFirst("Email")?.Value : "")"
                                    title="Agregar a favoritos"
                                    type="button"
                                    onclick="event.preventDefault(); event.stopPropagation();">
                                <img src="https://autoclickstorage.blob.core.windows.net/uploads/Component%20183.png" 
                                     alt="Favorito" />
                            </button>
                            
                            <!-- Botón de Contactar Vendedor fuera del link con estilo btn-primario -->
                            <button class="busqueda-contact-btn" 
                                    onclick="event.preventDefault(); event.stopPropagation(); mostrarModalVendedor(@auto.Id, '@(auto.Propietario?.NombreCompleto ?? "")', '@(auto.Propietario?.NombreAMostrar ?? "")', '@(auto.Propietario?.NumeroTelefono ?? "")', '@(auto.UbicacionCompleta ?? "")', @(Model.Autos.Count(a => a.EmailPropietario == auto.EmailPropietario)));" 
                                    type="button">
                                Contactar vendedor
                            </button>
                        </div>
                    }
                </div>

                <!-- Advertisement Banner -->
                <div style="margin-bottom: 24px;">
                    @await Component.InvokeAsync("CarruselPublicidad", new { formato = "horizontal", seccion = "destacados-banner" })
                </div>

                <!-- Pagination -->
                <nav class="busqueda-pagination" aria-label="Paginación de búsqueda">
                    <div class="pagination-container">
                        <!-- Previous Button -->
                        <a href="@Url.Page("/Destacados", new { page = Model.CurrentPage - 1, sortBy = Model.SortBy })" 
                           class="busqueda-pagination-arrow @(Model.CurrentPage <= 1 ? "disabled" : "")">
                            <div class="pagination-arrow-icon left"></div>
                        </a>

                        <!-- Page Numbers -->
                        @for (int i = 1; i <= Math.Min(5, Model.TotalPages); i++)
                        {
                            <a href="@Url.Page("/Destacados", new { page = i, sortBy = Model.SortBy })" 
                               class="busqueda-pagination-number @(Model.CurrentPage == i ? "active" : "")">
                                @i
                            </a>
                        }

                        @if (Model.TotalPages > 5)
                        {
                            <span class="busqueda-pagination-ellipsis">…</span>
                            
                            <a href="@Url.Page("/Destacados", new { page = Model.TotalPages, sortBy = Model.SortBy })" 
                               class="busqueda-pagination-number @(Model.CurrentPage == Model.TotalPages ? "active" : "")">
                                @Model.TotalPages
                            </a>
                        }

                        <!-- Next Button -->
                        <a href="@Url.Page("/Destacados", new { page = Model.CurrentPage + 1, sortBy = Model.SortBy })" 
                           class="busqueda-pagination-arrow @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")">
                            <div class="pagination-arrow-icon right"></div>
                        </a>
                    </div>
                </nav>

                <!-- Advertisement after pagination -->
                <div style="margin-top: 48px;">
                    @await Component.InvokeAsync("CarruselPublicidad", new { formato = "horizontal", seccion = "destacados-footer" })
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
</div>

<!-- Filter Modal (Mobile & Tablet) -->
<div id="filterModal" class="busqueda-filter-modal">
    <div class="busqueda-filter-modal-content">
        <div class="busqueda-filter-modal-header">
            <h3 class="busqueda-filter-modal-title">Filtros de búsqueda</h3>
            <button class="busqueda-filter-modal-close" onclick="closeFilterModal()">&times;</button>
        </div>
        <div class="busqueda-filter-modal-body">
            <form method="get" id="mobileFilterForm">
                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="sortBy" value="@Model.SortBy" />

                <!-- Provincia -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Provincia</label>
                    <div class="busqueda-select-wrapper">
                        <select name="province" class="busqueda-filter-select" id="province-select-modal" onchange="onProvinceChange(this)">
                            <option value="">Todas las provincias</option>
                            @foreach (var province in Model.AvailableProvinces)
                            {
                                <option value="@province" selected="@(Model.Province == province)">@province</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Cantón -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Cantón</label>
                    <div class="busqueda-select-wrapper">
                        <select name="canton" class="busqueda-filter-select" id="canton-select-modal">
                            <option value="">Todos los cantones</option>
                            @foreach (var canton in Model.AvailableCantons)
                            {
                                <option value="@canton" selected="@(Model.Canton == canton)">@canton</option>
                            }
                        </select>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Marca -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Marca</label>
                    <div class="busqueda-select-wrapper">
                        <select name="brand" class="busqueda-filter-select" id="brand-select-modal" onchange="onBrandChange(this)">
                            <option value="">Todas las marcas</option>
                            @foreach (var brand in Model.AvailableBrands)
                            {
                                <option value="@brand" selected="@(Model.Brand == brand)">@brand</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Modelo -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Modelo</label>
                    <div class="busqueda-select-wrapper">
                        <select name="model" class="busqueda-filter-select" id="model-select-modal">
                            <option value="">Todos los modelos</option>
                            @foreach (var modelName in Model.AvailableModels)
                            {
                                <option value="@modelName" selected="@(Model.Model == modelName)">@modelName</option>
                            }
                        </select>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Rango de precio -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Rango de precio</label>
                    <div class="busqueda-price-range">
                        <div class="price-input-group">
                            <label class="price-input-label">Min</label>
                            <input type="number" name="minPrice" placeholder="$" class="busqueda-price-field" value="@Model.MinPrice" />
                        </div>
                        <span class="price-separator">hasta</span>
                        <div class="price-input-group">
                            <label class="price-input-label">Max</label>
                            <input type="number" name="maxPrice" placeholder="$" class="busqueda-price-field" value="@Model.MaxPrice" />
                        </div>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Kilometraje -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Kilometraje</label>
                    <div class="busqueda-price-range">
                        <div class="price-input-group">
                            <label class="price-input-label">Min</label>
                            <input type="number" name="minKm" class="busqueda-price-field" value="@Model.MinKm" />
                        </div>
                        <span class="price-separator">hasta</span>
                        <div class="price-input-group">
                            <label class="price-input-label">Max</label>
                            <input type="number" name="maxKm" class="busqueda-price-field" value="@Model.MaxKm" />
                        </div>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Año -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Año</label>
                    <div class="busqueda-price-range">
                        <div class="price-input-group">
                            <label class="price-input-label">Min</label>
                            <div class="busqueda-select-wrapper">
                                <select name="minYear" class="busqueda-filter-select small">
                                    <option value="">Cualquiera</option>
                                    @foreach (var year in Model.AvailableYears)
                                    {
                                        <option value="@year" selected="@(Model.MinYear == year)">@year</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <span class="price-separator">hasta</span>
                        <div class="price-input-group">
                            <label class="price-input-label">Max</label>
                            <div class="busqueda-select-wrapper">
                                <select name="maxYear" class="busqueda-filter-select small">
                                    <option value="">Cualquiera</option>
                                    @foreach (var year in Model.AvailableYears)
                                    {
                                        <option value="@year" selected="@(Model.MaxYear == year)">@year</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Carrocería -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Carrocería</label>
                    <div class="busqueda-select-wrapper">
                        <select name="bodyType" class="busqueda-filter-select">
                            <option value="">Todas las carrocerías</option>
                            @foreach (var bodyType in Model.AvailableBodyTypes)
                            {
                                <option value="@bodyType" selected="@(Model.BodyType == bodyType)">@bodyType</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Combustible -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Combustible/Propulsión</label>
                    <div class="busqueda-select-wrapper">
                        <select name="fuelType" class="busqueda-filter-select">
                            <option value="">Todos los combustibles</option>
                            @foreach (var fuelType in Model.AvailableFuelTypes)
                            {
                                <option value="@fuelType" selected="@(Model.FuelType == fuelType)">@fuelType</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Transmisión -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Transmisión</label>
                    <div class="busqueda-select-wrapper">
                        <select name="transmission" class="busqueda-filter-select">
                            <option value="">Todas las transmisiones</option>
                            @foreach (var transmission in Model.AvailableTransmissions)
                            {
                                <option value="@transmission" selected="@(Model.Transmission == transmission)">@transmission</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Condición -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Condición</label>
                    <div class="busqueda-select-wrapper">
                        <select name="condition" class="busqueda-filter-select">
                            <option value="">Todas las condiciones</option>
                            @foreach (var condition in Model.AvailableConditions)
                            {
                                <option value="@condition" selected="@(Model.Condition == condition)">@condition</option>
                            }
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="busqueda-filter-modal-actions">
            <button class="busqueda-filter-clear-btn" onclick="clearAllFilters()">Limpiar</button>
            <button class="busqueda-filter-apply-btn" onclick="applyFilters()">Aplicar</button>
        </div>
    </div>
</div>

<script src="~/js/favoritos.js"></script>
<script>
// Filter Modal Functions
function openFilterModal() {
    document.getElementById('filterModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeFilterModal() {
    document.getElementById('filterModal').classList.remove('active');
    document.body.style.overflow = '';
}

function applyFilters() {
    document.getElementById('mobileFilterForm').submit();
}

// Close filter modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const filterModal = document.getElementById('filterModal');
    if (filterModal) {
        filterModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeFilterModal();
            }
        });
    }
});

function changeBusquedaSorting(sortBy) {
    const url = new URL(window.location);
    url.searchParams.set('sortBy', sortBy);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function onProvinceChange(selectElement) {
    const provinceSelect = selectElement || document.getElementById('province-select');
    const isModal = provinceSelect && provinceSelect.id.includes('modal');
    
    const cantonSelect = isModal ? 
        document.getElementById('canton-select-modal') : 
        document.getElementById('canton-select');
    
    const provincia = provinceSelect.value;
    
    // Clear canton selection
    cantonSelect.innerHTML = '<option value="">Todos los cantones</option>';
    
    // Cantones by province (simplificado - idealmente desde el servidor)
    const cantonesPorProvincia = {
        'San José': ['Central', 'Escazú', 'Desamparados', 'Puriscal', 'Tarrazú', 'Aserrí', 'Mora', 'Goicoechea', 'Santa Ana', 'Alajuelita', 'Coronado', 'Acosta', 'Tibás', 'Moravia', 'Montes de Oca', 'Turrubares', 'Dota', 'Curridabat', 'Pérez Zeledón', 'León Cortés'],
        'Alajuela': ['Central', 'San Ramón', 'Grecia', 'San Mateo', 'Atenas', 'Naranjo', 'Palmares', 'Poás', 'Orotina', 'San Carlos', 'Zarcero', 'Sarchí', 'Upala', 'Los Chiles', 'Guatuso'],
        'Cartago': ['Central', 'Paraíso', 'La Unión', 'Jiménez', 'Turrialba', 'Alvarado', 'Oreamuno', 'El Guarco'],
        'Heredia': ['Central', 'Barva', 'Santo Domingo', 'Santa Bárbara', 'San Rafael', 'San Isidro', 'Belén', 'Flores', 'San Pablo', 'Sarapiquí'],
        'Guanacaste': ['Liberia', 'Nicoya', 'Santa Cruz', 'Bagaces', 'Carrillo', 'Cañas', 'Abangares', 'Tilarán', 'Nandayure', 'La Cruz', 'Hojancha'],
        'Puntarenas': ['Central', 'Esparza', 'Buenos Aires', 'Montes de Oro', 'Osa', 'Quepos', 'Golfito', 'Coto Brus', 'Parrita', 'Corredores', 'Garabito'],
        'Limón': ['Central', 'Pococí', 'Siquirres', 'Talamanca', 'Matina', 'Guácimo']
    };
    
    if (cantonesPorProvincia[provincia]) {
        cantonesPorProvincia[provincia].forEach(canton => {
            const option = document.createElement('option');
            option.value = canton;
            option.textContent = canton;
            cantonSelect.appendChild(option);
        });
    }
    
    // Si no es modal, auto-submit
    if (!isModal && provincia) {
        setTimeout(() => {
            const form = document.querySelector('.busqueda-filters-form');
            if (form) form.submit();
        }, 100);
    }
}

function onBrandChange(selectElement) {
    const brandSelect = selectElement || document.getElementById('brand-select');
    const isModal = brandSelect && brandSelect.id.includes('modal');
    
    const modelSelect = isModal ? 
        document.getElementById('model-select-modal') : 
        document.getElementById('model-select');
    
    const marca = brandSelect.value;
    
    // Clear model selection
    modelSelect.innerHTML = '<option value="">Todos los modelos</option>';
    
    // Models by brand (simplificado)
    const modelosPorMarca = {
        'Toyota': ['Corolla', 'Camry', 'Prius', 'RAV4', 'Highlander', 'Tacoma', 'Tundra', '4Runner', 'Sienna', 'Avalon', 'Land Cruiser', 'Yaris'],
        'Honda': ['Civic', 'Accord', 'CR-V', 'Pilot', 'Fit', 'HR-V', 'Passport', 'Ridgeline', 'Insight', 'Odyssey'],
        'Nissan': ['Sentra', 'Altima', 'Maxima', 'Rogue', 'Pathfinder', 'Murano', 'Frontier', 'Titan', 'Armada', 'Leaf', 'Kicks', 'Versa'],
        'Hyundai': ['Elantra', 'Sonata', 'Tucson', 'Santa Fe', 'Kona', 'Palisade', 'Accent', 'Veloster', 'Genesis', 'Ioniq'],
        'Kia': ['Forte', 'Optima', 'Sportage', 'Sorento', 'Soul', 'Seltos', 'Telluride', 'Stinger', 'Niro', 'Carnival'],
        'Mazda': ['Mazda3', 'Mazda6', 'CX-3', 'CX-5', 'CX-9', 'MX-5', 'CX-30', 'Mazda2', 'BT-50'],
        'Chevrolet': ['Spark', 'Sonic', 'Cruze', 'Malibu', 'Equinox', 'Traverse', 'Silverado', 'Tahoe', 'Suburban'],
        'Ford': ['Fiesta', 'Focus', 'Fusion', 'Escape', 'Explorer', 'F-150', 'Ranger', 'Expedition', 'Mustang'],
        'Volkswagen': ['Jetta', 'Passat', 'Tiguan', 'Atlas', 'Golf', 'Beetle', 'Touareg', 'Arteon']
    };
    
    if (modelosPorMarca[marca]) {
        modelosPorMarca[marca].forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo;
            option.textContent = modelo;
            modelSelect.appendChild(option);
        });
    }
    
    // Si no es modal, auto-submit
    if (!isModal && marca) {
        setTimeout(() => {
            const form = document.querySelector('.busqueda-filters-form');
            if (form) form.submit();
        }, 100);
    }
}

function removeFilter(filterValue) {
    const url = new URL(window.location);
    
    // Check which parameter to remove based on the filter value
    const currentBrand = '@Model.Brand';
    const currentModel = '@Model.Model';
    const currentProvince = '@Model.Province';
    const currentCanton = '@Model.Canton';
    const currentBodyType = '@Model.BodyType';
    const currentFuelType = '@Model.FuelType';
    const currentTransmission = '@Model.Transmission';
    const currentCondition = '@Model.Condition';
    
    if (filterValue === currentBrand) {
        url.searchParams.delete('brand');
        url.searchParams.delete('model'); // Also clear model when removing brand
    } else if (filterValue === currentModel) {
        url.searchParams.delete('model');
    } else if (filterValue === currentProvince) {
        url.searchParams.delete('province');
        url.searchParams.delete('canton'); // Also clear canton when removing province
    } else if (filterValue === currentCanton) {
        url.searchParams.delete('canton');
    } else if (filterValue === currentBodyType) {
        url.searchParams.delete('bodyType');
    } else if (filterValue === currentFuelType) {
        url.searchParams.delete('fuelType');
    } else if (filterValue === currentTransmission) {
        url.searchParams.delete('transmission');
    } else if (filterValue === currentCondition) {
        url.searchParams.delete('condition');
    } else if (filterValue.includes('₡')) {
        // Price range filter
        url.searchParams.delete('minPrice');
        url.searchParams.delete('maxPrice');
    } else if (filterValue.includes('km')) {
        // Kilometrage filter
        url.searchParams.delete('minKm');
        url.searchParams.delete('maxKm');
    } else if (/^\d{4}/.test(filterValue)) {
        // Year filter (starts with 4 digits)
        url.searchParams.delete('minYear'); 
        url.searchParams.delete('maxYear');
    }
    
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function clearAllFilters() {
    const url = new URL(window.location.origin + window.location.pathname);
    url.searchParams.set('page', '1');
    url.searchParams.set('sortBy', '@Model.SortBy');
    window.location.href = url.toString();
}

// Auto-submit form when any filter changes (optional - for better UX)
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('.busqueda-filter-select:not(#province-select):not(#brand-select)');
    const inputs = document.querySelectorAll('.busqueda-price-field');
    
    selects.forEach(select => {
        select.addEventListener('change', function() {
            // Small delay to allow multiple rapid changes
            clearTimeout(this.changeTimeout);
            this.changeTimeout = setTimeout(() => {
                document.querySelector('.busqueda-filters-form').submit();
            }, 500);
        });
    });
    
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            // Longer delay for text inputs
            clearTimeout(this.inputTimeout);
            this.inputTimeout = setTimeout(() => {
                document.querySelector('.busqueda-filters-form').submit();
            }, 1000);
        });
    });
});

// Funciones del Modal de Contactar Vendedor
function mostrarModalVendedor(autoId, nombreCompleto, nombreMostrar, telefono, ubicacion, cantidadAutos) {
    const modal = document.getElementById('modalVendedor');
    const modalVendorName = document.getElementById('modalVendorName');
    const modalVendorNameRow = document.getElementById('modalVendorNameRow');
    const modalPhone = document.getElementById('modalPhone');
    const modalPhoneRow = document.getElementById('modalPhoneRow');
    const modalPhoneBtn = document.getElementById('modalPhoneBtn');
    const modalWhatsappBtn = document.getElementById('modalWhatsappBtn');
    const modalLocation = document.getElementById('modalLocation');
    const modalLocationRow = document.getElementById('modalLocationRow');
    const modalCarsCount = document.getElementById('modalCarsCount');
    const modalCarsCountRow = document.getElementById('modalCarsCountRow');
    
    // Set vendor name
    if (nombreMostrar && nombreMostrar.trim() !== '') {
        modalVendorName.textContent = nombreMostrar;
        modalVendorNameRow.style.display = 'flex';
    } else if (nombreCompleto && nombreCompleto.trim() !== '') {
        modalVendorName.textContent = nombreCompleto;
        modalVendorNameRow.style.display = 'flex';
    } else {
        modalVendorNameRow.style.display = 'none';
    }
    
    // Set phone
    if (telefono && telefono.trim() !== '') {
        modalPhone.textContent = telefono;
        modalPhoneRow.style.display = 'flex';
        
        // Set phone button href
        modalPhoneBtn.href = 'tel:' + telefono;
        modalPhoneBtn.style.display = 'flex';
        
        // Set WhatsApp button href
        const message = encodeURIComponent('Hola, estoy interesado en su vehículo publicado en AutoClick.cr');
        modalWhatsappBtn.href = 'https://wa.me/' + telefono.replace(/[^0-9]/g, '') + '?text=' + message;
        modalWhatsappBtn.style.display = 'flex';
    } else {
        modalPhoneRow.style.display = 'none';
        modalPhoneBtn.style.display = 'none';
        modalWhatsappBtn.style.display = 'none';
    }
    
    // Set location
    if (ubicacion && ubicacion.trim() !== '') {
        modalLocation.textContent = ubicacion;
        modalLocationRow.style.display = 'flex';
    } else {
        modalLocationRow.style.display = 'none';
    }
    
    // Set cars count
    if (cantidadAutos && cantidadAutos > 0) {
        modalCarsCount.textContent = cantidadAutos + (cantidadAutos === 1 ? ' vehículo' : ' vehículos');
        modalCarsCountRow.style.display = 'flex';
    } else {
        modalCarsCountRow.style.display = 'none';
    }
    
    // Show modal
    modal.style.display = 'flex';
}

function cerrarModalVendedor() {
    const modal = document.getElementById('modalVendedor');
    modal.style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('modalVendedor');
    if (event.target === modal) {
        cerrarModalVendedor();
    }
}
</script>

<!-- Modal de Contactar Vendedor -->
<div id="modalVendedor" class="modal-vendedor" style="display: none;">
    <div class="modal-vendedor-content">
        <button class="modal-vendedor-close" onclick="cerrarModalVendedor()">&times;</button>
        
        <h3 class="modal-vendedor-title">Contactar vendedor</h3>
        
        <div class="modal-vendedor-buttons">
            <a id="modalPhoneBtn" href="" class="modal-vendedor-btn modal-vendedor-btn-phone">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                Llamar
            </a>
            
            <a id="modalWhatsappBtn" href="" class="modal-vendedor-btn modal-vendedor-btn-whatsapp" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
                WhatsApp
            </a>
        </div>
        
        <div class="modal-vendedor-info">
            <div class="modal-vendedor-info-row" id="modalVendorNameRow">
                <span class="modal-vendedor-info-label">Vendedor:</span>
                <span id="modalVendorName" class="modal-vendedor-info-value"></span>
            </div>
            
            <div class="modal-vendedor-info-row" id="modalPhoneRow">
                <span class="modal-vendedor-info-label">Teléfono:</span>
                <span id="modalPhone" class="modal-vendedor-info-value"></span>
            </div>
            
            <div class="modal-vendedor-info-row" id="modalLocationRow">
                <span class="modal-vendedor-info-label">Ubicación:</span>
                <span id="modalLocation" class="modal-vendedor-info-value"></span>
            </div>
            
            <div class="modal-vendedor-info-row" id="modalCarsCountRow">
                <span class="modal-vendedor-info-label">Vehículos:</span>
                <span id="modalCarsCount" class="modal-vendedor-info-value"></span>
            </div>
        </div>
    </div>
</div>






