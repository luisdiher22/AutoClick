@page "/destacados"
@model DestacadosModel
@{
    ViewData["Title"] = "Destacados - AutoClick.cr";
}

@section Styles {
    <link rel="stylesheet" href="~/css/destacados-responsive.css" asp-append-version="true" />
}

<!-- Dark Theme Page Container -->
<div class="busqueda-avanzada-page">
    <div class="busqueda-container">
        <!-- Breadcrumb Navigation -->
        <nav class="busqueda-breadcrumb">
            <a asp-page="/Index" class="breadcrumb-link">Inicio</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">Destacados</span>
        </nav>

        <div class="busqueda-content">
            <!-- Sidebar Filters -->
            <aside class="busqueda-sidebar">
                <!-- Filter Container -->
                <div class="busqueda-filters-container">
                    <div class="busqueda-filters-section">
                        <!-- Filters Header -->
                        <h3 class="busqueda-filters-title">Filtros de búsqueda</h3>
                        
                        <!-- Applied Filters Tags -->
                        @if (Model.AppliedFilters.Any())
                        {
                            <div class="applied-filters-tags">
                                @foreach (var filter in Model.AppliedFilters)
                                {
                                    <div class="filter-tag">
                                        <span>@filter</span>
                                        <button class="remove-filter-btn" onclick="removeFilter('@filter')" title="Eliminar filtro">×</button>
                                    </div>
                                }
                            </div>
                            
                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />
                        }

                        <!-- Filter Form -->
                        <form method="get" class="busqueda-filters-form">
                            <input type="hidden" name="page" value="1" />
                            <input type="hidden" name="sortBy" value="@Model.SortBy" />

                            <!-- Provincia -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Provincia</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="province" class="busqueda-filter-select" id="province-select" onchange="onProvinceChange()">
                                        <option value="">Todas las provincias</option>
                                        @foreach (var province in Model.AvailableProvinces)
                                        {
                                            <option value="@province" selected="@(Model.Province == province)">@province</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Cantón -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Cantón</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="canton" class="busqueda-filter-select" id="canton-select">
                                        <option value="">Todos los cantones</option>
                                        @foreach (var canton in Model.AvailableCantons)
                                        {
                                            <option value="@canton" selected="@(Model.Canton == canton)">@canton</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Marca -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Marca</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="brand" class="busqueda-filter-select" id="brand-select" onchange="onBrandChange()">
                                        <option value="">Todas las marcas</option>
                                        @foreach (var brand in Model.AvailableBrands)
                                        {
                                            <option value="@brand" selected="@(Model.Brand == brand)">@brand</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Modelo -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Modelo</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="model" class="busqueda-filter-select" id="model-select">
                                        <option value="">Todos los modelos</option>
                                        @foreach (var modelName in Model.AvailableModels)
                                        {
                                            <option value="@modelName" selected="@(Model.Model == modelName)">@modelName</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Rango de precio -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Rango de precio</label>
                                <div class="busqueda-price-range">
                                    <div class="price-input-group">
                                        <label class="price-input-label">Min</label>
                                        <input type="number" name="minPrice" placeholder="$" class="busqueda-price-field" value="@Model.MinPrice" />
                                    </div>
                                    <span class="price-separator">hasta</span>
                                    <div class="price-input-group">
                                        <label class="price-input-label">Max</label>
                                        <input type="number" name="maxPrice" placeholder="$" class="busqueda-price-field" value="@Model.MaxPrice" />
                                    </div>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Kilometraje -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Kilometraje</label>
                                <div class="busqueda-price-range">
                                    <div class="price-input-group">
                                        <label class="price-input-label">Min</label>
                                        <input type="number" name="minKm" class="busqueda-price-field" value="@Model.MinKm" />
                                    </div>
                                    <span class="price-separator">hasta</span>
                                    <div class="price-input-group">
                                        <label class="price-input-label">Max</label>
                                        <input type="number" name="maxKm" class="busqueda-price-field" value="@Model.MaxKm" />
                                    </div>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Año -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Año</label>
                                <div class="busqueda-price-range">
                                    <div class="price-input-group">
                                        <label class="price-input-label">Min</label>
                                        <div class="busqueda-select-wrapper">
                                            <select name="minYear" class="busqueda-filter-select small">
                                                <option value="">Cualquiera</option>
                                                @foreach (var year in Model.AvailableYears)
                                                {
                                                    <option value="@year" selected="@(Model.MinYear == year)">@year</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <span class="price-separator">hasta</span>
                                    <div class="price-input-group">
                                        <label class="price-input-label">Max</label>
                                        <div class="busqueda-select-wrapper">
                                            <select name="maxYear" class="busqueda-filter-select small">
                                                <option value="">Cualquiera</option>
                                                @foreach (var year in Model.AvailableYears)
                                                {
                                                    <option value="@year" selected="@(Model.MaxYear == year)">@year</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Línea divisoria -->
                            <hr class="filter-divider" />

                            <!-- Additional Filters -->
                            <!-- Carrocería -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Carrocería</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="bodyType" class="busqueda-filter-select">
                                        <option value="">Todas las carrocerías</option>
                                        @foreach (var bodyType in Model.AvailableBodyTypes)
                                        {
                                            <option value="@bodyType" selected="@(Model.BodyType == bodyType)">@bodyType</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Combustible -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Combustible/Propulsión</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="fuelType" class="busqueda-filter-select">
                                        <option value="">Todos los combustibles</option>
                                        @foreach (var fuelType in Model.AvailableFuelTypes)
                                        {
                                            <option value="@fuelType" selected="@(Model.FuelType == fuelType)">@fuelType</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Transmisión -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Transmisión</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="transmission" class="busqueda-filter-select">
                                        <option value="">Todas las transmisiones</option>
                                        @foreach (var transmission in Model.AvailableTransmissions)
                                        {
                                            <option value="@transmission" selected="@(Model.Transmission == transmission)">@transmission</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Condición -->
                            <div class="busqueda-filter-group">
                                <label class="busqueda-filter-label">Condición</label>
                                <div class="busqueda-select-wrapper">
                                    <select name="condition" class="busqueda-filter-select">
                                        <option value="">Todas las condiciones</option>
                                        @foreach (var condition in Model.AvailableConditions)
                                        {
                                            <option value="@condition" selected="@(Model.Condition == condition)">@condition</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Sidebar Advertisement -->
                <div style="margin-top: 24px;">
                    @await Component.InvokeAsync("CarruselPublicidad", new { formato = "cuadrado", seccion = "destacados-sidebar" })
                </div>
            </aside>

            <!-- Main Content -->
            <main class="busqueda-main">
                <!-- Sort Dropdown -->
                <div class="busqueda-sort-header">
                    <!-- Mobile/Tablet Filter Button -->
                    <button class="busqueda-filter-btn-mobile" onclick="openFilterModal()">
                        <!-- Icono Figma: controles verticales (estilo sliders) -->
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                            <g stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
                                <!-- Línea izquierda + círculo -->
                                <path d="M4.5 3V15"/>
                                <circle cx="4.5" cy="6.5" r="1.6" fill="currentColor"/>
                                <!-- Línea centro + círculo -->
                                <path d="M9 3V15"/>
                                <circle cx="9" cy="11.5" r="1.6" fill="currentColor"/>
                                <!-- Línea derecha + círculo -->
                                <path d="M13.5 3V15"/>
                                <circle cx="13.5" cy="8.5" r="1.6" fill="currentColor"/>
                            </g>
                        </svg>
                        Filtros
                    </button>

                    <div class="busqueda-sort-wrapper">
                        <select class="busqueda-sort-select" onchange="changeBusquedaSorting(this.value)">
                            <option value="recent" selected="@(Model.SortBy == "recent")">Ordenar por: Más recientes</option>
                            <option value="price-asc" selected="@(Model.SortBy == "price-asc")">Ordenar por: Precio menor a mayor</option>
                            <option value="price-desc" selected="@(Model.SortBy == "price-desc")">Ordenar por: Precio mayor a menor</option>
                            <option value="year" selected="@(Model.SortBy == "year")">Ordenar por: Año más nuevo</option>
                        </select>
                    </div>
                </div>

                <!-- Cars Grid - 2 Columns -->
                <div class="busqueda-cars-grid">
                    @foreach (var auto in Model.Autos)
                    {
                        <div class="busqueda-auto-card">
                            <!-- Banderín superior derecho (fuera del link) -->
                            @if (Model.BanderinUrls.ContainsKey(auto.Id) && Model.BanderinUrls[auto.Id].Any())
                            {
                                <div class="busqueda-banderin-container" data-auto-id="@auto.Id" data-banderin-count="@Model.BanderinUrls[auto.Id].Count">
                                    <div class="busqueda-banderin-carousel">
                                        @for (int i = 0; i < Model.BanderinUrls[auto.Id].Count; i++)
                                        {
                                            <img src="@Model.BanderinUrls[auto.Id][i]" class="@(i == 0 ? "active" : "")" alt="Banderín" />
                                        }
                                    </div>
                                </div>
                            }
                            
                            <a asp-page="/Producto" asp-route-id="@auto.Id" class="busqueda-auto-card-link">
                                <!-- Car Image -->
                                <div class="busqueda-auto-card-image">
                                    <img src="@auto.ImagenPrincipal" alt="@auto.NombreCompleto" />
                                </div>

                                <!-- Car Info Container with dark background -->
                                <div class="busqueda-auto-card-info">
                                    <!-- Top row: Title only -->
                                    <div class="busqueda-auto-card-row-top">
                                        <div class="busqueda-auto-card-title">@auto.NombreCompleto</div>
                                    </div>
                                    
                                    <!-- Middle row: Price on left, KM + Cuota on right -->
                                    <div class="busqueda-auto-card-row-middle">
                                        <div class="busqueda-auto-card-price">@auto.PrecioEnCRC</div>
                                        <div class="busqueda-auto-card-right-info">
                                            <div class="busqueda-auto-card-km">@auto.Kilometraje km</div>
                                            <div class="busqueda-auto-card-cuota">Est. ₡@((auto.Precio * 0.015m).ToString("N0"))/mes</div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                            
                            <!-- Botón de Favoritos fuera del link -->
                            <button class="busqueda-favorite-btn favorite-btn" 
                                    data-auto-id="@auto.Id" 
                                    data-email-usuario="@(User.Identity?.IsAuthenticated == true ? User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? User.FindFirst("Email")?.Value : "")"
                                    title="Agregar a favoritos"
                                    type="button"
                                    onclick="event.preventDefault(); event.stopPropagation();">
                                <img src="https://autoclickstorage.blob.core.windows.net/uploads/Component%20183.png" 
                                     alt="Favorito" />
                            </button>
                            
                            <!-- Botón de Contactar Vendedor fuera del link con estilo btn-primario -->
                            <button class="busqueda-contact-btn" 
                                    onclick="event.preventDefault(); event.stopPropagation(); mostrarModalVendedor(@auto.Id, '@(auto.Propietario?.NombreCompleto ?? "")', '@(auto.Propietario?.NombreAMostrar ?? "")', '@(auto.Propietario?.NumeroTelefono ?? "")', '@(auto.UbicacionCompleta ?? "")', @(Model.Autos.Count(a => a.EmailPropietario == auto.EmailPropietario)));" 
                                    type="button">
                                Contactar vendedor
                            </button>
                        </div>
                    }
                </div>

                <!-- Advertisement Banner -->
                <div style="margin-bottom: 24px;">
                    @await Component.InvokeAsync("CarruselPublicidad", new { formato = "horizontal", seccion = "destacados-banner" })
                </div>

                <!-- Pagination -->
                <nav class="busqueda-pagination" aria-label="Paginación de búsqueda">
                    <div class="pagination-container">
                        <!-- Previous Button -->
                        <a href="@Url.Page("/Destacados", new { page = Model.CurrentPage - 1, sortBy = Model.SortBy })" 
                           class="busqueda-pagination-arrow @(Model.CurrentPage <= 1 ? "disabled" : "")">
                            <div class="pagination-arrow-icon left"></div>
                        </a>

                        <!-- Page Numbers -->
                        @for (int i = 1; i <= Math.Min(5, Model.TotalPages); i++)
                        {
                            <a href="@Url.Page("/Destacados", new { page = i, sortBy = Model.SortBy })" 
                               class="busqueda-pagination-number @(Model.CurrentPage == i ? "active" : "")">
                                @i
                            </a>
                        }

                        @if (Model.TotalPages > 5)
                        {
                            <span class="busqueda-pagination-ellipsis">…</span>
                            
                            <a href="@Url.Page("/Destacados", new { page = Model.TotalPages, sortBy = Model.SortBy })" 
                               class="busqueda-pagination-number @(Model.CurrentPage == Model.TotalPages ? "active" : "")">
                                @Model.TotalPages
                            </a>
                        }

                        <!-- Next Button -->
                        <a href="@Url.Page("/Destacados", new { page = Model.CurrentPage + 1, sortBy = Model.SortBy })" 
                           class="busqueda-pagination-arrow @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")">
                            <div class="pagination-arrow-icon right"></div>
                        </a>
                    </div>
                </nav>

                <!-- Advertisement after pagination -->
                <div style="margin-top: 48px;">
                    @await Component.InvokeAsync("CarruselPublicidad", new { formato = "horizontal", seccion = "destacados-footer" })
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
</div>

<!-- Filter Modal (Mobile & Tablet) -->
<div id="filterModal" class="busqueda-filter-modal">
    <div class="busqueda-filter-modal-content">
        <div class="busqueda-filter-modal-header">
            <h3 class="busqueda-filter-modal-title">Filtros de búsqueda</h3>
            <button class="busqueda-filter-modal-close" onclick="closeFilterModal()">&times;</button>
        </div>
        <div class="busqueda-filter-modal-body">
            <form method="get" id="mobileFilterForm">
                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="sortBy" value="@Model.SortBy" />

                <!-- Provincia -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Provincia</label>
                    <div class="busqueda-select-wrapper">
                        <select name="province" class="busqueda-filter-select" id="province-select-modal" onchange="onProvinceChange(this)">
                            <option value="">Todas las provincias</option>
                            @foreach (var province in Model.AvailableProvinces)
                            {
                                <option value="@province" selected="@(Model.Province == province)">@province</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Cantón -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Cantón</label>
                    <div class="busqueda-select-wrapper">
                        <select name="canton" class="busqueda-filter-select" id="canton-select-modal">
                            <option value="">Todos los cantones</option>
                            @foreach (var canton in Model.AvailableCantons)
                            {
                                <option value="@canton" selected="@(Model.Canton == canton)">@canton</option>
                            }
                        </select>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Marca -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Marca</label>
                    <div class="busqueda-select-wrapper">
                        <select name="brand" class="busqueda-filter-select" id="brand-select-modal" onchange="onBrandChange(this)">
                            <option value="">Todas las marcas</option>
                            @foreach (var brand in Model.AvailableBrands)
                            {
                                <option value="@brand" selected="@(Model.Brand == brand)">@brand</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Modelo -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Modelo</label>
                    <div class="busqueda-select-wrapper">
                        <select name="model" class="busqueda-filter-select" id="model-select-modal">
                            <option value="">Todos los modelos</option>
                            @foreach (var modelName in Model.AvailableModels)
                            {
                                <option value="@modelName" selected="@(Model.Model == modelName)">@modelName</option>
                            }
                        </select>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Rango de precio -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Rango de precio</label>
                    <div class="busqueda-price-range">
                        <div class="price-input-group">
                            <label class="price-input-label">Min</label>
                            <input type="number" name="minPrice" placeholder="$" class="busqueda-price-field" value="@Model.MinPrice" />
                        </div>
                        <span class="price-separator">hasta</span>
                        <div class="price-input-group">
                            <label class="price-input-label">Max</label>
                            <input type="number" name="maxPrice" placeholder="$" class="busqueda-price-field" value="@Model.MaxPrice" />
                        </div>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Kilometraje -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Kilometraje</label>
                    <div class="busqueda-price-range">
                        <div class="price-input-group">
                            <label class="price-input-label">Min</label>
                            <input type="number" name="minKm" class="busqueda-price-field" value="@Model.MinKm" />
                        </div>
                        <span class="price-separator">hasta</span>
                        <div class="price-input-group">
                            <label class="price-input-label">Max</label>
                            <input type="number" name="maxKm" class="busqueda-price-field" value="@Model.MaxKm" />
                        </div>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Año -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Año</label>
                    <div class="busqueda-price-range">
                        <div class="price-input-group">
                            <label class="price-input-label">Min</label>
                            <div class="busqueda-select-wrapper">
                                <select name="minYear" class="busqueda-filter-select small">
                                    <option value="">Cualquiera</option>
                                    @foreach (var year in Model.AvailableYears)
                                    {
                                        <option value="@year" selected="@(Model.MinYear == year)">@year</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <span class="price-separator">hasta</span>
                        <div class="price-input-group">
                            <label class="price-input-label">Max</label>
                            <div class="busqueda-select-wrapper">
                                <select name="maxYear" class="busqueda-filter-select small">
                                    <option value="">Cualquiera</option>
                                    @foreach (var year in Model.AvailableYears)
                                    {
                                        <option value="@year" selected="@(Model.MaxYear == year)">@year</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="filter-divider" />

                <!-- Carrocería -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Carrocería</label>
                    <div class="busqueda-select-wrapper">
                        <select name="bodyType" class="busqueda-filter-select">
                            <option value="">Todas las carrocerías</option>
                            @foreach (var bodyType in Model.AvailableBodyTypes)
                            {
                                <option value="@bodyType" selected="@(Model.BodyType == bodyType)">@bodyType</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Combustible -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Combustible/Propulsión</label>
                    <div class="busqueda-select-wrapper">
                        <select name="fuelType" class="busqueda-filter-select">
                            <option value="">Todos los combustibles</option>
                            @foreach (var fuelType in Model.AvailableFuelTypes)
                            {
                                <option value="@fuelType" selected="@(Model.FuelType == fuelType)">@fuelType</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Transmisión -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Transmisión</label>
                    <div class="busqueda-select-wrapper">
                        <select name="transmission" class="busqueda-filter-select">
                            <option value="">Todas las transmisiones</option>
                            @foreach (var transmission in Model.AvailableTransmissions)
                            {
                                <option value="@transmission" selected="@(Model.Transmission == transmission)">@transmission</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Condición -->
                <div class="busqueda-filter-group">
                    <label class="busqueda-filter-label">Condición</label>
                    <div class="busqueda-select-wrapper">
                        <select name="condition" class="busqueda-filter-select">
                            <option value="">Todas las condiciones</option>
                            @foreach (var condition in Model.AvailableConditions)
                            {
                                <option value="@condition" selected="@(Model.Condition == condition)">@condition</option>
                            }
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="busqueda-filter-modal-actions">
            <button class="busqueda-filter-clear-btn" onclick="clearAllFilters()">Limpiar</button>
            <button class="busqueda-filter-apply-btn" onclick="applyFilters()">Aplicar</button>
        </div>
    </div>
</div>

<script src="~/js/favoritos.js"></script>
<script>
// Filter Modal Functions
function openFilterModal() {
    document.getElementById('filterModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeFilterModal() {
    document.getElementById('filterModal').classList.remove('active');
    document.body.style.overflow = '';
}

function applyFilters() {
    document.getElementById('mobileFilterForm').submit();
}

// Close filter modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const filterModal = document.getElementById('filterModal');
    if (filterModal) {
        filterModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeFilterModal();
            }
        });
    }
});

function changeBusquedaSorting(sortBy) {
    const url = new URL(window.location);
    url.searchParams.set('sortBy', sortBy);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function onProvinceChange(selectElement) {
    const provinceSelect = selectElement || document.getElementById('province-select');
    const isModal = provinceSelect && provinceSelect.id.includes('modal');
    
    const cantonSelect = isModal ? 
        document.getElementById('canton-select-modal') : 
        document.getElementById('canton-select');
    
    const provincia = provinceSelect.value;
    
    // Clear canton selection
    cantonSelect.innerHTML = '<option value="">Todos los cantones</option>';
    
    // Cantones by province (simplificado - idealmente desde el servidor)
    const cantonesPorProvincia = {
        'San José': ['Central', 'Escazú', 'Desamparados', 'Puriscal', 'Tarrazú', 'Aserrí', 'Mora', 'Goicoechea', 'Santa Ana', 'Alajuelita', 'Coronado', 'Acosta', 'Tibás', 'Moravia', 'Montes de Oca', 'Turrubares', 'Dota', 'Curridabat', 'Pérez Zeledón', 'León Cortés'],
        'Alajuela': ['Central', 'San Ramón', 'Grecia', 'San Mateo', 'Atenas', 'Naranjo', 'Palmares', 'Poás', 'Orotina', 'San Carlos', 'Zarcero', 'Sarchí', 'Upala', 'Los Chiles', 'Guatuso'],
        'Cartago': ['Central', 'Paraíso', 'La Unión', 'Jiménez', 'Turrialba', 'Alvarado', 'Oreamuno', 'El Guarco'],
        'Heredia': ['Central', 'Barva', 'Santo Domingo', 'Santa Bárbara', 'San Rafael', 'San Isidro', 'Belén', 'Flores', 'San Pablo', 'Sarapiquí'],
        'Guanacaste': ['Liberia', 'Nicoya', 'Santa Cruz', 'Bagaces', 'Carrillo', 'Cañas', 'Abangares', 'Tilarán', 'Nandayure', 'La Cruz', 'Hojancha'],
        'Puntarenas': ['Central', 'Esparza', 'Buenos Aires', 'Montes de Oro', 'Osa', 'Quepos', 'Golfito', 'Coto Brus', 'Parrita', 'Corredores', 'Garabito'],
        'Limón': ['Central', 'Pococí', 'Siquirres', 'Talamanca', 'Matina', 'Guácimo']
    };
    
    if (cantonesPorProvincia[provincia]) {
        cantonesPorProvincia[provincia].forEach(canton => {
            const option = document.createElement('option');
            option.value = canton;
            option.textContent = canton;
            cantonSelect.appendChild(option);
        });
    }
    
    // Si no es modal, auto-submit
    if (!isModal && provincia) {
        setTimeout(() => {
            const form = document.querySelector('.busqueda-filters-form');
            if (form) form.submit();
        }, 100);
    }
}

function onBrandChange(selectElement) {
    const brandSelect = selectElement || document.getElementById('brand-select');
    const isModal = brandSelect && brandSelect.id.includes('modal');
    
    const modelSelect = isModal ? 
        document.getElementById('model-select-modal') : 
        document.getElementById('model-select');
    
    const marca = brandSelect.value;
    
    // Clear model selection
    modelSelect.innerHTML = '<option value="">Todos los modelos</option>';
    
    // Models by brand (simplificado)
    const modelosPorMarca = {
        'Toyota': ['Corolla', 'Camry', 'Prius', 'RAV4', 'Highlander', 'Tacoma', 'Tundra', '4Runner', 'Sienna', 'Avalon', 'Land Cruiser', 'Yaris'],
        'Honda': ['Civic', 'Accord', 'CR-V', 'Pilot', 'Fit', 'HR-V', 'Passport', 'Ridgeline', 'Insight', 'Odyssey'],
        'Nissan': ['Sentra', 'Altima', 'Maxima', 'Rogue', 'Pathfinder', 'Murano', 'Frontier', 'Titan', 'Armada', 'Leaf', 'Kicks', 'Versa'],
        'Hyundai': ['Elantra', 'Sonata', 'Tucson', 'Santa Fe', 'Kona', 'Palisade', 'Accent', 'Veloster', 'Genesis', 'Ioniq'],
        'Kia': ['Forte', 'Optima', 'Sportage', 'Sorento', 'Soul', 'Seltos', 'Telluride', 'Stinger', 'Niro', 'Carnival'],
        'Mazda': ['Mazda3', 'Mazda6', 'CX-3', 'CX-5', 'CX-9', 'MX-5', 'CX-30', 'Mazda2', 'BT-50'],
        'Chevrolet': ['Spark', 'Sonic', 'Cruze', 'Malibu', 'Equinox', 'Traverse', 'Silverado', 'Tahoe', 'Suburban'],
        'Ford': ['Fiesta', 'Focus', 'Fusion', 'Escape', 'Explorer', 'F-150', 'Ranger', 'Expedition', 'Mustang'],
        'Volkswagen': ['Jetta', 'Passat', 'Tiguan', 'Atlas', 'Golf', 'Beetle', 'Touareg', 'Arteon']
    };
    
    if (modelosPorMarca[marca]) {
        modelosPorMarca[marca].forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo;
            option.textContent = modelo;
            modelSelect.appendChild(option);
        });
    }
    
    // Si no es modal, auto-submit
    if (!isModal && marca) {
        setTimeout(() => {
            const form = document.querySelector('.busqueda-filters-form');
            if (form) form.submit();
        }, 100);
    }
}

function removeFilter(filterValue) {
    const url = new URL(window.location);
    
    // Check which parameter to remove based on the filter value
    const currentBrand = '@Model.Brand';
    const currentModel = '@Model.Model';
    const currentProvince = '@Model.Province';
    const currentCanton = '@Model.Canton';
    const currentBodyType = '@Model.BodyType';
    const currentFuelType = '@Model.FuelType';
    const currentTransmission = '@Model.Transmission';
    const currentCondition = '@Model.Condition';
    
    if (filterValue === currentBrand) {
        url.searchParams.delete('brand');
        url.searchParams.delete('model'); // Also clear model when removing brand
    } else if (filterValue === currentModel) {
        url.searchParams.delete('model');
    } else if (filterValue === currentProvince) {
        url.searchParams.delete('province');
        url.searchParams.delete('canton'); // Also clear canton when removing province
    } else if (filterValue === currentCanton) {
        url.searchParams.delete('canton');
    } else if (filterValue === currentBodyType) {
        url.searchParams.delete('bodyType');
    } else if (filterValue === currentFuelType) {
        url.searchParams.delete('fuelType');
    } else if (filterValue === currentTransmission) {
        url.searchParams.delete('transmission');
    } else if (filterValue === currentCondition) {
        url.searchParams.delete('condition');
    } else if (filterValue.includes('₡')) {
        // Price range filter
        url.searchParams.delete('minPrice');
        url.searchParams.delete('maxPrice');
    } else if (filterValue.includes('km')) {
        // Kilometrage filter
        url.searchParams.delete('minKm');
        url.searchParams.delete('maxKm');
    } else if (/^\d{4}/.test(filterValue)) {
        // Year filter (starts with 4 digits)
        url.searchParams.delete('minYear'); 
        url.searchParams.delete('maxYear');
    }
    
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function clearAllFilters() {
    const url = new URL(window.location.origin + window.location.pathname);
    url.searchParams.set('page', '1');
    url.searchParams.set('sortBy', '@Model.SortBy');
    window.location.href = url.toString();
}

// Auto-submit form when any filter changes (optional - for better UX)
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('.busqueda-filter-select:not(#province-select):not(#brand-select)');
    const inputs = document.querySelectorAll('.busqueda-price-field');
    
    selects.forEach(select => {
        select.addEventListener('change', function() {
            // Small delay to allow multiple rapid changes
            clearTimeout(this.changeTimeout);
            this.changeTimeout = setTimeout(() => {
                document.querySelector('.busqueda-filters-form').submit();
            }, 500);
        });
    });
    
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            // Longer delay for text inputs
            clearTimeout(this.inputTimeout);
            this.inputTimeout = setTimeout(() => {
                document.querySelector('.busqueda-filters-form').submit();
            }, 1000);
        });
    });
});

// Funciones del Modal de Contactar Vendedor
function mostrarModalVendedor(autoId, nombreCompleto, nombreMostrar, telefono, ubicacion, cantidadAutos) {
    console.log('=== MODAL DEBUG ===');
    console.log('autoId:', autoId);
    console.log('nombreCompleto:', nombreCompleto, 'Type:', typeof nombreCompleto, 'Length:', nombreCompleto ? nombreCompleto.length : 0);
    console.log('nombreMostrar:', nombreMostrar, 'Type:', typeof nombreMostrar, 'Length:', nombreMostrar ? nombreMostrar.length : 0);
    console.log('telefono:', telefono, 'Type:', typeof telefono, 'Length:', telefono ? telefono.length : 0);
    console.log('ubicacion:', ubicacion);
    console.log('cantidadAutos:', cantidadAutos);
    console.log('==================');
    
    // Mostrar nombre del vendedor - usar nombreMostrar o nombreCompleto
    const nombreElement = document.getElementById('modalVendedorNombre');
    const nombreFinal = (nombreMostrar && nombreMostrar.trim() !== '') ? nombreMostrar : 
                        (nombreCompleto && nombreCompleto.trim() !== '') ? nombreCompleto : 
                        'Vendedor';
    
    console.log('Nombre final a mostrar:', nombreFinal);
    nombreElement.textContent = nombreFinal;
    nombreElement.style.display = 'block';
    
    // Configurar botón de teléfono
    const telBtn = document.getElementById('modalVendedorTelBtn');
    if (telefono && telefono.trim() !== '') {
        console.log('Configurando botón de teléfono con:', telefono);
        document.getElementById('modalVendedorTel').textContent = telefono;
        telBtn.onclick = () => window.location.href = 'tel:' + telefono;
        telBtn.style.display = 'flex';
    } else {
        console.log('Teléfono vacío, ocultando botón');
        telBtn.style.display = 'none';
    }
    
    // Configurar botón de WhatsApp
    const whatsappBtn = document.getElementById('modalVendedorWhatsAppBtn');
    if (telefono && telefono.trim() !== '') {
        console.log('Configurando botón de WhatsApp con:', telefono);
        document.getElementById('modalVendedorWhatsApp').textContent = telefono;
        const telefonoLimpio = telefono.replace(/[^0-9]/g, '');
        whatsappBtn.onclick = () => window.open('https://wa.me/' + telefonoLimpio, '_blank');
        whatsappBtn.style.display = 'flex';
    } else {
        console.log('Teléfono vacío, ocultando botón WhatsApp');
        whatsappBtn.style.display = 'none';
    }
    
    // Mostrar información de teléfono en la sección de info
    const telInfo = document.getElementById('modalVendedorTelInfo');
    if (telefono && telefono.trim() !== '') {
        document.getElementById('modalVendedorTelText').textContent = telefono;
        telInfo.style.display = 'flex';
    } else {
        telInfo.style.display = 'none';
    }
    
    // Mostrar ubicación
    const ubicacionDiv = document.getElementById('modalVendedorUbicacion');
    if (ubicacion && ubicacion.trim() !== '') {
        document.getElementById('modalVendedorUbicacionText').textContent = ubicacion;
        ubicacionDiv.style.display = 'flex';
    } else {
        ubicacionDiv.style.display = 'none';
    }
    
    // Mostrar cantidad de autos
    document.getElementById('modalVendedorAutosText').textContent = '(' + cantidadAutos + ' de autos publicados)';
    document.getElementById('modalVendedorAutos').style.display = 'flex';
    
    // Mostrar el modal
    document.getElementById('modalVendedor').style.display = 'flex';
    console.log('Modal abierto');
}

function cerrarModalVendedor() {
    document.getElementById('modalVendedor').style.display = 'none';
}

// Cerrar modal al hacer clic fuera
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('modalVendedor').addEventListener('click', function(e) {
        if (e.target === this) {
            cerrarModalVendedor();
        }
    });
});

// Carousel rotation for banderines
document.addEventListener('DOMContentLoaded', function() {
    function rotateBanderines(container) {
        const carousel = container.querySelector('.busqueda-banderin-carousel');
        if (!carousel) return;
        
        const items = carousel.querySelectorAll('img, video');
        if (items.length <= 1) return;
        
        let currentIndex = 0;
        
        function rotate() {
            items[currentIndex].classList.remove('active');
            currentIndex = (currentIndex + 1) % items.length;
            items[currentIndex].classList.add('active');
        }
        
        setInterval(rotate, 6000);
    }
    
    const banderinContainers = document.querySelectorAll('.busqueda-banderin-container');
    banderinContainers.forEach(container => {
        const count = parseInt(container.getAttribute('data-banderin-count') || '0');
        if (count > 1) {
            rotateBanderines(container);
        }
    });
});
</script>

<!-- Modal de Contactar Vendedor -->
<div id="modalVendedor" class="modal-vendedor" style="display: none;">
    <div class="modal-vendedor-content">
        <button class="modal-vendedor-close" onclick="cerrarModalVendedor()">×</button>
        <h3 class="modal-vendedor-title">Contactar al vendedor</h3>
        <p class="modal-vendedor-name" id="modalVendedorNombre"></p>
        
        <button class="modal-vendedor-phone-btn" id="modalVendedorTelBtn" onclick="">
            Llamar <span id="modalVendedorTel"></span>
        </button>
        
        <button class="modal-vendedor-whatsapp-btn" id="modalVendedorWhatsAppBtn" onclick="">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_modal)">
                    <path d="M14.5893 11.9223L14.5818 11.9848C12.7493 11.0715 12.5576 10.9498 12.3209 11.3048C12.1568 11.5506 11.6784 12.1081 11.5343 12.2731C11.3884 12.4356 11.2434 12.4481 10.9959 12.3356C10.7459 12.2106 9.94345 11.9481 8.99345 11.0981C8.25345 10.4356 7.75678 9.62315 7.61011 9.37315C7.36595 8.95148 7.87678 8.89148 8.34178 8.01148C8.42511 7.83648 8.38261 7.69898 8.32095 7.57482C8.25845 7.44982 7.76095 6.22482 7.55261 5.73648C7.35261 5.24982 7.14678 5.31148 6.99261 5.31148C6.51261 5.26982 6.16178 5.27648 5.85261 5.59815C4.50761 7.07648 4.84678 8.60148 5.99761 10.2231C8.25928 13.1831 9.46428 13.7281 11.6676 14.4848C12.2626 14.674 12.8051 14.6473 13.2343 14.5856C13.7126 14.5098 14.7068 13.9848 14.9143 13.3973C15.1268 12.8098 15.1268 12.3223 15.0643 12.2098C15.0026 12.0973 14.8393 12.0348 14.5893 11.9223Z" fill="white"/>
                    <path d="M17.1 2.87404C10.6925 -3.32013 0.0883333 1.17237 0.0841667 9.91071C0.0841667 11.6574 0.541667 13.3607 1.41333 14.8649L0 19.9999L5.27917 18.6232C11.8667 22.1815 19.9967 17.4565 20 9.91571C20 7.26904 18.9667 4.77821 17.0875 2.90654L17.1 2.87404ZM18.335 9.88821C18.33 16.249 11.3475 20.2215 5.825 16.9749L5.525 16.7965L2.4 17.609L3.2375 14.5715L3.03833 14.259C-0.398333 8.78821 3.55 1.63821 10.06 1.63821C12.2717 1.63821 14.3475 2.50071 15.9108 4.06321C17.4733 5.61237 18.335 7.68821 18.335 9.88821Z" fill="white"/>
                </g>
                <defs>
                    <clipPath id="clip0_modal">
                        <rect width="20" height="20" fill="white"/>
                    </clipPath>
                </defs>
            </svg>
            <span id="modalVendedorWhatsApp"></span>
        </button>
        
        <div class="modal-vendedor-info">
            <div class="modal-vendedor-info-row" id="modalVendedorTelInfo">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path d="M3 3h2l1.5 4-1.5 1.5c1 2 2.5 3.5 4.5 4.5L11 11.5l4 1.5v2c0 1.1-.9 2-2 2C6.477 17 2 12.523 2 6c0-1.1.9-2 2-2z" stroke="white" stroke-width="1.5"/>
                </svg>
                <span id="modalVendedorTelText"></span>
            </div>
            <div class="modal-vendedor-info-row" id="modalVendedorUbicacion">
                <svg width="14" height="17" viewBox="0 0 14 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6.58801 16.17C9.6369 13.034 12.6858 10.2259 12.6858 6.76199C12.6858 3.29806 9.95573 0.48999 6.58801 0.48999C3.22031 0.48999 0.490234 3.29806 0.490234 6.76199C0.490234 10.2259 3.53912 13.034 6.58801 16.17Z" stroke="white" stroke-width="0.98" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6.80668 8.3299C7.7689 8.3299 8.5489 7.54991 8.5489 6.58768C8.5489 5.62548 7.7689 4.84546 6.80668 4.84546C5.84445 4.84546 5.06445 5.62548 5.06445 6.58768C5.06445 7.54991 5.84445 8.3299 6.80668 8.3299Z" stroke="white" stroke-width="0.98" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span id="modalVendedorUbicacionText"></span>
            </div>
            <div class="modal-vendedor-info-row" id="modalVendedorAutos">
                <svg width="21" height="18" viewBox="0 0 21 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0.980469 4.60054L3.79609 6.94686C3.98199 7.10182 4.21632 7.18665 4.45832 7.18665H16.1226C16.3646 7.18665 16.5989 7.10182 16.7848 6.94686L19.6005 4.60054M4.60102 10.8072H4.61137M15.9799 10.8072H15.9903M6.31887 0.97998H14.2621C15.0045 0.97998 15.6901 1.3778 16.0583 2.02241L19.0553 7.26702C19.4125 7.89224 19.6005 8.5998 19.6005 9.31998V15.4622C19.6005 16.0335 19.1373 16.4966 18.566 16.4966H17.5316C16.9603 16.4966 16.4971 16.0335 16.4971 15.4622V14.4278H4.0838V15.4622C4.0838 16.0335 3.62066 16.4966 3.04936 16.4966H2.01491C1.44361 16.4966 0.980469 16.0335 0.980469 15.4622V9.31998C0.980469 8.5998 1.16839 7.89224 1.52565 7.26702L4.52257 2.02241C4.89092 1.3778 5.57643 0.97998 6.31887 0.97998ZM5.11825 10.8072C5.11825 11.0928 4.88668 11.3244 4.60102 11.3244C4.31537 11.3244 4.0838 11.0928 4.0838 10.8072C4.0838 10.5216 4.31537 10.29 4.60102 10.29C4.88668 10.29 5.11825 10.5216 5.11825 10.8072ZM16.4971 10.8072C16.4971 11.0928 16.2655 11.3244 15.9799 11.3244C15.6943 11.3244 15.4627 11.0928 15.4627 10.8072C15.4627 10.5216 15.6943 10.29 15.9799 10.29C16.2655 10.29 16.4971 10.5216 16.4971 10.8072Z" stroke="white" stroke-width="1.96" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span id="modalVendedorAutosText"></span>
            </div>
        </div>
    </div>
</div>






