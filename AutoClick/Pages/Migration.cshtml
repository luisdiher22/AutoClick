@page "/migration"
@{
    ViewData["Title"] = "Migración a Azure Blob Storage";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Migración de Banderines a Azure Blob Storage</h4>
                </div>
                <div class="card-body">
                    
                    <!-- Información de archivos locales -->
                    <div class="alert alert-info" id="localInfo">
                        <h6>Información de archivos locales:</h6>
                        <div id="localInfoContent">Cargando...</div>
                    </div>

                    <!-- Paso 1: Probar conexión -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5>Paso 1: Configurar Azure Storage</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="connectionString" class="form-label">Connection String de Azure Storage:</label>
                                <textarea class="form-control" id="connectionString" rows="3" placeholder="DefaultEndpointsProtocol=https;AccountName=..."></textarea>
                                <div class="form-text">
                                    Obtén esto desde Azure Portal → Storage Account → Access Keys → Connection String
                                </div>
                            </div>
                            <button id="testConnectionBtn" class="btn btn-outline-primary">
                                <i class="fas fa-plug"></i> Probar Conexión
                            </button>
                            <div id="connectionResult" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- Paso 2: Migrar archivos -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5>Paso 2: Migrar Archivos</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <strong>¡Atención!</strong> Este proceso subirá todos los banderines a Azure Blob Storage.
                                Asegúrate de haber probado la conexión primero.
                            </div>
                            <button id="migrateBtn" class="btn btn-success" disabled>
                                <i class="fas fa-cloud-upload-alt"></i> Iniciar Migración
                            </button>
                            <div id="migrationProgress" class="mt-3" style="display: none;">
                                <div class="progress mb-2">
                                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div id="progressText">Preparando migración...</div>
                            </div>
                            <div id="migrationResult" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- Paso 3: Configurar aplicación -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Paso 3: Configurar Aplicación</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <h6>Después de la migración exitosa:</h6>
                                <ol>
                                    <li>Actualiza tu <code>appsettings.json</code> con el connection string</li>
                                    <li>Configura <code>"UseAzureStorage": true</code></li>
                                    <li>Reinicia la aplicación</li>
                                    <li>Verifica que los banderines cargan desde Azure</li>
                                </ol>
                            </div>
                            <button id="updateConfigBtn" class="btn btn-warning" disabled>
                                <i class="fas fa-cog"></i> Mostrar Configuración
                            </button>
                            <div id="configOutput" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function() {
    loadLocalInfo();

    $('#testConnectionBtn').click(testConnection);
    $('#migrateBtn').click(startMigration);
    $('#updateConfigBtn').click(showConfiguration);
});

function loadLocalInfo() {
    $.get('/api/migration/local-info')
        .done(function(data) {
            if (data.exists) {
                $('#localInfoContent').html(`
                    <strong>Archivos encontrados:</strong> ${data.fileCount} archivos GIF<br>
                    <strong>Tamaño total:</strong> ${data.totalSizeMB} MB<br>
                    <strong>Ubicación:</strong> ${data.path}
                `);
            } else {
                $('#localInfoContent').html(`
                    <span class="text-danger">No se encontró el directorio: ${data.path}</span>
                `);
            }
        })
        .fail(function() {
            $('#localInfoContent').html('<span class="text-danger">Error cargando información local</span>');
        });
}

function testConnection() {
    const connectionString = $('#connectionString').val().trim();
    
    if (!connectionString) {
        showResult('#connectionResult', 'danger', 'Por favor ingresa un connection string');
        return;
    }

    $('#testConnectionBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Probando...');
    
    $.post('/api/migration/test-connection', {
        connectionString: connectionString
    })
    .done(function(data) {
        if (data.success) {
            showResult('#connectionResult', 'success', `✅ ${data.message}<br><small>Container URL: ${data.containerUrl}</small>`);
            $('#migrateBtn').prop('disabled', false);
            $('#updateConfigBtn').prop('disabled', false);
        } else {
            showResult('#connectionResult', 'danger', `❌ ${data.message}<br><small>${data.error}</small>`);
        }
    })
    .fail(function(xhr) {
        showResult('#connectionResult', 'danger', `❌ Error: ${xhr.responseJSON?.error || 'Error desconocido'}`);
    })
    .always(function() {
        $('#testConnectionBtn').prop('disabled', false).html('<i class="fas fa-plug"></i> Probar Conexión');
    });
}

function startMigration() {
    const connectionString = $('#connectionString').val().trim();
    
    if (!connectionString) {
        showResult('#migrationResult', 'danger', 'Por favor prueba la conexión primero');
        return;
    }

    $('#migrateBtn').prop('disabled', true);
    $('#migrationProgress').show();
    $('#progressBar').css('width', '10%');
    $('#progressText').text('Iniciando migración...');

    $.post('/api/migration/banderines', {
        connectionString: connectionString,
        storageAccountName: 'autoclickbanderines'
    })
    .done(function(data) {
        $('#progressBar').css('width', '100%').addClass('bg-success');
        $('#progressText').text('¡Migración completada!');
        
        let resultHtml = `
            <div class="alert alert-success">
                <h6>✅ ${data.message}</h6>
                <strong>Base URL:</strong> <a href="${data.baseUrl}" target="_blank">${data.baseUrl}</a><br>
                <strong>Archivos procesados:</strong> ${data.totalFiles}<br>
                <strong>Subidos exitosamente:</strong> ${data.uploadedCount}
            </div>
        `;
        
        if (data.results && data.results.length > 0) {
            resultHtml += '<div class="mt-2"><strong>Detalles:</strong><ul>';
            data.results.forEach(function(result) {
                if (result.success) {
                    resultHtml += `<li class="text-success">✅ ${result.fileName}</li>`;
                } else {
                    resultHtml += `<li class="text-danger">❌ ${result.fileName}: ${result.error}</li>`;
                }
            });
            resultHtml += '</ul></div>';
        }
        
        $('#migrationResult').html(resultHtml);
    })
    .fail(function(xhr) {
        $('#progressBar').addClass('bg-danger');
        $('#progressText').text('Error en la migración');
        showResult('#migrationResult', 'danger', `❌ Error: ${xhr.responseJSON?.message || 'Error desconocido'}`);
    })
    .always(function() {
        $('#migrateBtn').prop('disabled', false);
    });
}

function showConfiguration() {
    const connectionString = $('#connectionString').val().trim();
    
    const config = {
        "AzureStorage": {
            "AccountName": "autoclickbanderines",
            "ContainerName": "banderines"
        },
        "ConnectionStrings": {
            "AzureStorage": connectionString
        },
        "UseAzureStorage": true
    };
    
    const configHtml = `
        <div class="alert alert-warning">
            <h6>Configuración para appsettings.json:</h6>
            <pre class="bg-dark text-light p-3 rounded">${JSON.stringify(config, null, 2)}</pre>
            <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${JSON.stringify(config).replace(/"/g, '&quot;')}')">
                <i class="fas fa-copy"></i> Copiar
            </button>
        </div>
    `;
    
    $('#configOutput').html(configHtml);
}

function showResult(selector, type, message) {
    $(selector).html(`<div class="alert alert-${type}">${message}</div>`);
}

function copyToClipboard(text) {
    const cleanText = text.replace(/&quot;/g, '"');
    navigator.clipboard.writeText(cleanText).then(function() {
        Swal.fire({
            icon: 'success',
            title: 'Copiado',
            text: 'Configuración copiada al portapapeles',
            timer: 1500,
            showConfirmButton: false
        });
    });
}
</script>
}

<style>
.card-header h5 {
    margin: 0;
}
pre {
    max-height: 300px;
    overflow-y: auto;
}
</style>

