@page
@model AutoClick.Pages.Pagos.ProcessPaymentModel
@{
    ViewData["Title"] = "Pagar Publicidad";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header text-white" style="background-color: #06174D;">
                    <h3 class="mb-0">
                        <i class="fas fa-credit-card"></i> Procesar Pago
                    </h3>
                </div>
                <div class="card-body">
                    <div id="payment-summary" class="mb-4">
                        <h5>Resumen del Pago</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Descripción:</strong> <span id="payment-description">Publicidad AutoClick</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Monto:</strong> <span id="payment-amount">$0.00</span></p>
                            </div>
                        </div>
                    </div>

                    <hr />

                    <!-- Mensajes de estado -->
                    <div id="payment-messages">
                        <div id="loading-message" class="alert alert-info" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Procesando pago...
                        </div>
                        <div id="success-message" class="alert alert-success" style="display: none;">
                            <i class="fas fa-check-circle"></i> <span id="success-text"></span>
                        </div>
                        <div id="error-message" class="alert alert-danger" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i> <span id="error-text"></span>
                        </div>
                    </div>

                    <!-- Contenedor para el SDK de ONVO -->
                    <div id="onvo-payment-container"></div>

                    <!-- Botón de cancelar -->
                    <div class="mt-3 text-center">
                        <button type="button" class="btn" style="background-color: #FF931E; color: white; border: none;" onclick="cancelPayment()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- SDK de ONVO Pay -->
    <script src="https://sdk.onvopay.com/sdk.js"></script>

    <script>
        // Configuración del pago
        let paymentConfig = {
            autoId: @(ViewBag.AutoId ?? 0),
            anuncioId: @(ViewBag.AnuncioId ?? 0),
            amount: @(ViewBag.Amount ?? 0),
            currency: '@(ViewBag.Currency ?? "CRC")',
            description: '@(ViewBag.Description ?? "Pago AutoClick")'
        };

        // Elementos del DOM
        const loadingMessage = document.getElementById('loading-message');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const paymentContainer = document.getElementById('onvo-payment-container');

        // Inicializar el pago
        async function initializePayment() {
            try {
                showLoading(true);
                hideMessages();

                // Crear Payment Intent en el backend
                const response = await fetch('/api/pagos/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: paymentConfig.amount,
                        currency: paymentConfig.currency,
                        description: paymentConfig.description,
                        autoId: paymentConfig.autoId || null,
                        anuncioPublicidadId: paymentConfig.anuncioId || null
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error al crear sesión de pago');
                }

                const data = await response.json();

                // Actualizar resumen con los datos del backend
                document.getElementById('payment-description').textContent = data.description || paymentConfig.description;
                document.getElementById('payment-amount').textContent = 
                    formatAmount(data.amount, data.currency);

                // Inicializar SDK de ONVO
                const onvoInstance = onvo.pay({
                    publicKey: data.publishableKey,
                    paymentIntentId: data.paymentIntentId,
                    paymentType: 'one_time',
                    locale: 'es',
                    onSuccess: handlePaymentSuccess,
                    onError: handlePaymentError
                });

                // Renderizar el formulario de pago
                onvoInstance.render('#onvo-payment-container');

                showLoading(false);

            } catch (error) {
                console.error('Error inicializando pago:', error);
                showError(error.message);
                showLoading(false);
            }
        }

        // Manejar pago exitoso
        function handlePaymentSuccess(data) {
            console.log('Pago procesado - datos completos:', JSON.stringify(data));
            console.log('Estado del pago:', data.status);
            console.log('AutoId configurado:', paymentConfig.autoId);

            // Deshabilitar botón de cancelar inmediatamente
            disableCancelButton();

            // Verificar el estado - aceptar múltiples estados de éxito
            // ONVO puede devolver 'succeeded', 'success', 'completed', 'paid', etc.
            const successStates = ['succeeded', 'success', 'completed', 'paid', 'approved'];
            const isSuccess = successStates.includes(data.status?.toLowerCase()) || data.success === true;
            
            if (isSuccess || data.status === 'succeeded') {
                showSuccess('¡Pago procesado exitosamente! Procesando tu anuncio...');
                
                // Activar el auto en la base de datos
                if (paymentConfig.autoId && paymentConfig.autoId > 0) {
                    console.log('Llamando a activar-auto para autoId:', paymentConfig.autoId);
                    
                    fetch(`/api/pagos/activar-auto/${paymentConfig.autoId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => {
                        console.log('Respuesta de activar-auto:', response.status, response.statusText);
                        return response.json().then(jsonData => ({
                            ok: response.ok,
                            data: jsonData
                        }));
                    }).then(result => {
                        if (result.ok) {
                            console.log('Respuesta del servidor:', result.data);
                            // Limpiar el estado guardado del formulario
                            sessionStorage.removeItem('anuncioFormState');
                            
                            // Verificar si requiere aprobación (plan gratuito con banderines)
                            if (result.data.requiresApproval) {
                                showSuccess('¡Pago exitoso! Tu anuncio está pendiente de aprobación por un administrador.');
                            } else {
                                showSuccess('¡Anuncio activado! Redirigiendo...');
                            }
                        } else {
                            console.error('Error al activar auto:', result.data);
                            showSuccess('Pago exitoso. Redirigiendo...');
                        }
                    }).catch(error => {
                        console.error('Error al activar auto:', error);
                        showSuccess('Pago exitoso. Redirigiendo...');
                    }).finally(() => {
                        // Redirigir después de 2 segundos
                        setTimeout(() => {
                            window.location.href = '/AnunciarMiAuto?success=true';
                        }, 2000);
                    });
                } else {
                    console.log('No hay autoId para activar, redirigiendo...');
                    // Redirigir después de 2 segundos (sin auto para activar)
                    setTimeout(() => {
                        window.location.href = '/AnunciarMiAuto?success=true';
                    }, 2000);
                }
            } 
            else if (data.status === 'processing') {
                showSuccess('Tu pago está siendo procesado. Te notificaremos cuando se complete.');
                
                setTimeout(() => {
                    window.location.href = '/AnunciarMiAuto?success=true';
                }, 3000);
            }
            else if (data.status === 'requires_payment_method') {
                enableCancelButton(); // Rehabilitar si falla
                showError('El pago fue rechazado. Por favor, verifica tu método de pago e intenta nuevamente.');
            }
            else {
                showError('Estado de pago desconocido. Por favor, contacta a soporte.');
            }
        }

        // Manejar error en el pago
        function handlePaymentError(data) {
            console.error('Error en el pago:', data);
            
            let errorMsg = 'Ocurrió un error procesando el pago. ';
            
            if (data.message) {
                errorMsg += data.message;
            } else {
                errorMsg += 'Por favor, intenta nuevamente.';
            }

            showError(errorMsg);
        }

        // Cancelar pago - regresar a sección 6 para que recargue imágenes
        function cancelPayment() {
            // Mostrar modal de confirmación
            const modalHtml = `
                <div class="modal fade" id="cancelModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content" style="background: #02081C; border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 8px;">
                            <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.25);">
                                <h5 class="modal-title" style="color: white; font-family: 'Montserrat', sans-serif; font-weight: 700;">¿Regresar al formulario?</h5>
                            </div>
                            <div class="modal-body" style="color: rgba(255, 255, 255, 0.8); font-family: 'Montserrat', sans-serif;">
                                <p>Si regresas, tendrás que <strong>volver a cargar las imágenes</strong> de tu vehículo.</p>
                                <p>El resto de tu información se mantendrá guardada.</p>
                            </div>
                            <div class="modal-footer" style="border-top: 1px solid rgba(255, 255, 255, 0.25);">
                                <button type="button" class="btn" style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3);" onclick="$('#cancelModal').modal('hide')">Continuar con el pago</button>
                                <button type="button" class="btn" style="background: #FF931E; color: white; border: none;" onclick="confirmCancel()">Sí, regresar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            $('#cancelModal').modal('show');
            $('#cancelModal').on('hidden.bs.modal', function () {
                $(this).remove();
            });
        }
        
        function confirmCancel() {
            $('#cancelModal').modal('hide');
            
            // Si hay un autoId, eliminar el auto inactivo antes de regresar
            if (paymentConfig.autoId && paymentConfig.autoId > 0) {
                fetch(`/api/pagos/cancelar-auto/${paymentConfig.autoId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    console.log('Auto pendiente eliminado:', response.ok);
                }).catch(error => {
                    console.error('Error al eliminar auto pendiente:', error);
                }).finally(() => {
                    // Redirigir a la sección 6 (multimedia) con parámetro para mostrar modal de imágenes
                    window.location.href = '/AnunciarMiAuto?section=6&reloadImages=true';
                });
            } else {
                // Redirigir a la sección 6 (multimedia) con parámetro para mostrar modal de imágenes
                window.location.href = '/AnunciarMiAuto?section=6&reloadImages=true';
            }
        }

        // Funciones de UI
        function showLoading(show) {
            loadingMessage.style.display = show ? 'block' : 'none';
            paymentContainer.style.display = show ? 'none' : 'block';
        }

        function showSuccess(message) {
            hideMessages();
            document.getElementById('success-text').textContent = message;
            successMessage.style.display = 'block';
            paymentContainer.style.display = 'none';
        }

        function showError(message) {
            hideMessages();
            document.getElementById('error-text').textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideMessages() {
            loadingMessage.style.display = 'none';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
        }

        // Funciones para el botón de cancelar
        function disableCancelButton() {
            const cancelBtn = document.querySelector('button[onclick="cancelPayment()"]');
            if (cancelBtn) {
                cancelBtn.disabled = true;
                cancelBtn.style.opacity = '0.5';
                cancelBtn.style.cursor = 'not-allowed';
                cancelBtn.style.pointerEvents = 'none';
                cancelBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            }
        }

        function enableCancelButton() {
            const cancelBtn = document.querySelector('button[onclick="cancelPayment()"]');
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.style.opacity = '1';
                cancelBtn.style.cursor = 'pointer';
                cancelBtn.style.pointerEvents = 'auto';
                cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
            }
        }

        function formatAmount(amount, currency) {
            const amountInUnits = amount / 100;
            return new Intl.NumberFormat('es-CR', {
                style: 'currency',
                currency: currency
            }).format(amountInUnits);
        }

        // Iniciar cuando la página cargue
        document.addEventListener('DOMContentLoaded', initializePayment);
    </script>
}
