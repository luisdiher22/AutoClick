@page "/producto/{id:int}"
@model ProductoModel
@{
    ViewData["Title"] = $"{Model.Vehicle?.NombreCompleto} - AutoClick.cr";
}

<!-- Dark Theme Product Page -->
<div class="producto-page">
    <div class="producto-container">
        <!-- Breadcrumb Navigation -->
        <nav class="producto-breadcrumb">
            <a asp-page="/Index" class="breadcrumb-link">Inicio</a>
            <span class="breadcrumb-separator">/</span>
            <a asp-page="/Explorar" class="breadcrumb-link">Explorar todos los autos</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">@Model.Vehicle?.NombreCompleto</span>
        </nav>

        <div class="producto-content">
            <!-- Main Image Gallery -->
            @if (Model.Vehicle != null)
            {
                <div class="producto-gallery">
                    <div class="producto-main-image">
                        @if (!string.IsNullOrEmpty(Model.Vehicle.ImagenPrincipal))
                        {
                            <img src="@Model.Vehicle.ImagenPrincipal" alt="@Model.Vehicle.NombreCompleto" class="main-car-image" style="object-fit: contain;" />
                        }

                        <!-- Navigation Arrows -->
                        <button class="gallery-nav-btn prev-btn">
                            <div class="nav-arrow left"></div>
                        </button>
                        <button class="gallery-nav-btn next-btn">
                            <div class="nav-arrow right"></div>
                        </button>
                    </div>

                    <!-- Thumbnail Gallery -->
                    @{
                        var imageUrls = Model.Vehicle.ImagenesUrlsList ?? new List<string>();
                        if (imageUrls.Count == 0 && !string.IsNullOrEmpty(Model.Vehicle.ImagenPrincipal))
                        {
                            imageUrls = new List<string> { Model.Vehicle.ImagenPrincipal };
                        }
                    }

                    @if (imageUrls.Count > 0)
                    {
                        <div class="producto-thumbnails">
                            @{
                                var maxThumbnails = Math.Min(8, imageUrls.Count);
                            }
                            @for (int i = 0; i < maxThumbnails; i++)
                            {
                                <div class="thumbnail-item @(i == 0 ? "active" : "")">
                                    @if (i == 7 && imageUrls.Count > 8)
                                    {
                                        <img src="@imageUrls[i]" alt="Más imágenes" style="object-fit: contain;" />
                                        <div class="thumbnail-overlay">
                                            <div class="plus-icon">+</div>
                                        </div>
                                    }
                                    else
                                    {
                                        <img src="@imageUrls[i]" alt="@Model.Vehicle.NombreCompleto vista @(i + 1)" style="object-fit: contain;" />
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Right Sidebar -->
            <div class="producto-sidebar">
                <!-- Car Information Card -->
                <div class="producto-info-card">
                    <h1 class="producto-car-title">@Model.Vehicle?.NombreCompleto</h1>
                    <p class="producto-car-mileage">@Model.FormatKilometrage(Model.Vehicle?.Kilometraje ?? 0)</p>
                    <p class="producto-car-price">@Model.FormatPrice(Model.Vehicle?.ValorFiscal ?? 0)</p>

                    <div class="producto-payment-estimate">
                        <h3>Cuota estimada</h3>
                        <p>@Model.FormatPrice(Model.MonthlyPayment)/mes</p>
                    </div>

                    <div class="producto-actions">
                        <div class="producto-icons">
                            <button class="favorite-btn">
                                <div class="heart-icon"></div>
                            </button>
                            <button class="share-btn">
                                <div class="share-icon"></div>
                            </button>
                        </div>

                        <button class="producto-preapproval-btn">
                            Solicitar pre-aprobación
                        </button>
                    </div>
                </div>

                <!-- Contact Seller Card -->
                <div class="producto-contact-card">
                    <h3>Contactar al vendedor</h3>
                    @if (Model.Vehicle?.Propietario != null)
                    {
                        <p class="seller-name">@Model.Vehicle.Propietario.NombreCompleto</p>

                        <button class="contact-phone-btn">
                            Llamar @Model.Vehicle.Propietario.NumeroTelefono
                        </button>

                        <button class="contact-whatsapp-btn">
                            <div class="whatsapp-icon"></div>
                            @Model.Vehicle.Propietario.NumeroTelefono
                        </button>
                    }
                </div>

                <!-- Seller Information Card -->
                @if (Model.Vehicle?.Propietario != null)
                {
                    <div class="producto-seller-card">
                        <h3>Información del vendedor</h3>
                        <p class="seller-business-name">@Model.Vehicle.Propietario.NombreAMostrar</p>

                        <div class="seller-contact-info">
                            @if (!string.IsNullOrEmpty(Model.Vehicle.Propietario.NumeroTelefono))
                            {
                                <div class="seller-phones">
                                    <div class="phone-icon"></div>
                                    <span>@Model.Vehicle.Propietario.NumeroTelefono</span>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(Model.Vehicle.UbicacionCompleta))
                            {
                                <div class="seller-location">
                                    <div class="location-icon"></div>
                                    <span>@Model.Vehicle.UbicacionCompleta</span>
                                </div>
                            }

                            <div class="seller-car-count">
                                <div class="car-icon"></div>
                                <span>(@Model.SellerCarCount de autos publicados)</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Description Section -->
        @if (Model.Vehicle != null)
        {
            <section class="producto-description">
                <h2>Descripción</h2>
                <p>
                    @{
                        var descripcion = $"Potencia, elegancia y tecnología se fusionan en este impresionante {Model.Vehicle.NombreCompleto}, diseñado para quienes exigen rendimiento sin renunciar al confort. ";

                        if (Model.Vehicle.Kilometraje > 0)
                        {
                            descripcion += $"Con {Model.FormatKilometrage(Model.Vehicle.Kilometraje)}. ";
                        }

                        if (!string.IsNullOrEmpty(Model.Vehicle.Combustible))
                        {
                            descripcion += $"Propulsión: {Model.Vehicle.Combustible}. ";
                        }

                        if (!string.IsNullOrEmpty(Model.Vehicle.Transmision))
                        {
                            descripcion += $"Transmisión {Model.Vehicle.Transmision}. ";
                        }

                        if (!string.IsNullOrEmpty(Model.Vehicle.UbicacionCompleta))
                        {
                            descripcion += $"Ubicado en {Model.Vehicle.UbicacionCompleta}.";
                        }
                    }
                    @descripcion
                </p>
            </section>
        }

        <!-- Specifications Section -->
        @if (Model.Vehicle != null)
        {
        <section class="producto-specifications">
            <h2>Especificaciones</h2>
            <div class="specs-grid">
                <div class="spec-column">
                    <div class="spec-item">
                        <h3>Marca</h3>
                        <p>@Model.ToTitleCase(Model.Vehicle?.Marca)</p>
                    </div>
                    <div class="spec-item">
                        <h3>Modelo</h3>
                        <p>@Model.ToTitleCase(Model.Vehicle?.Modelo)</p>
                    </div>
                    <div class="spec-item">
                        <h3>Año</h3>
                        <p>@Model.Vehicle?.Ano</p>
                    </div>
                </div>
                
                <div class="spec-column">
                    <div class="spec-item">
                        <h3>Kilometraje</h3>
                        <p>@Model.FormatKilometrage(Model.Vehicle?.Kilometraje ?? 0)</p>
                    </div>
                    <div class="spec-item">
                        <h3>Carrocería</h3>
                        <p>@Model.Vehicle?.Carroceria</p>
                    </div>
                    <div class="spec-item">
                        <h3>Número de puertas</h3>
                        <p>@Model.Vehicle?.NumeroPuertas</p>
                    </div>
                </div>
                
                <div class="spec-column">
                    <div class="spec-item">
                        <h3>Motor</h3>
                        <p>@Model.Vehicle?.Cilindrada</p>
                    </div>
                    <div class="spec-item">
                        <h3>Propulsión</h3>
                        <p>@Model.Vehicle?.Combustible</p>
                    </div>
                    <div class="spec-item">
                        <h3>Transmisión</h3>
                        <p>@Model.Vehicle?.Transmision</p>
                    </div>
                </div>
            </div>
        </section>
        }

        <!-- Equipment Section -->
        @{
            var allExtras = new List<string>();
            if (Model.Vehicle != null)
            {
                allExtras.AddRange(Model.Vehicle.ExtrasInteriorList ?? new List<string>());
                allExtras.AddRange(Model.Vehicle.ExtrasExteriorList ?? new List<string>());
                allExtras.AddRange(Model.Vehicle.ExtrasMultimediaList ?? new List<string>());
                allExtras.AddRange(Model.Vehicle.ExtrasSeguridadList ?? new List<string>());
                allExtras.AddRange(Model.Vehicle.ExtrasRendimientoList ?? new List<string>());
                allExtras.AddRange(Model.Vehicle.ExtrasAntiRoboList ?? new List<string>());

                // Capitalizar primera letra de cada item
                allExtras = allExtras.Where(e => !string.IsNullOrEmpty(e))
                    .Select(e => char.ToUpper(e[0]) + e.Substring(1).ToLower())
                    .ToList();
            }

            var halfCount = (int)Math.Ceiling(allExtras.Count / 2.0);
        }

        @if (allExtras.Count > 0)
        {
            <section class="producto-equipment">
                <h2>Equipamiento</h2>
                <div class="equipment-grid">
                    <div class="equipment-column">
                        @for (int i = 0; i < halfCount && i < allExtras.Count; i++)
                        {
                            <div class="equipment-item">• @allExtras[i]</div>
                        }
                    </div>
                    <div class="equipment-column">
                        @for (int i = halfCount; i < allExtras.Count; i++)
                        {
                            <div class="equipment-item">• @allExtras[i]</div>
                        }
                    </div>
                </div>
            </section>
        }

        <!-- Marchamo Calculator Section -->
        @if (Model.Vehicle != null)
        {
            <section class="producto-marchamo">
                <div class="marchamo-content">
                    <div class="marchamo-header">
                        <p class="marchamo-subtitle">Calculadora de marchamo y traspaso</p>
                    </div>

                    <h2 class="marchamo-car-title">@Model.Vehicle.NombreCompleto</h2>

                    <div class="marchamo-sections">
                        <div class="marchamo-section">
                            <h3>Marchamo 2025</h3>
                            <p class="coming-soon">DISPONIBLE PRÓXIMAMENTE</p>
                        </div>

                        <div class="marchamo-section">
                            <h3>Costos de traspaso</h3>
                            <p class="coming-soon">DISPONIBLE PRÓXIMAMENTE</p>
                        </div>
                    </div>

                    <p class="marchamo-powered">Impulsado por AutoClick.cr</p>
                </div>

                <div class="marchamo-disclaimer">
                    Autoclick.cr informa que los valores presentados en esta plataforma son únicamente estimaciones de referencia. El cálculo oficial del marchamo corresponde al Instituto Nacional de Seguros (INS) y el monto exacto de los gastos de traspaso debe ser determinado por un abogado autorizado. Autoclick.cr no se hace responsable por diferencias entre los valores estimados y los montos oficiales.
                </div>
            </section>
        }

        <!-- Market Value Section -->
        @if (Model.Vehicle != null)
        {
            <section class="producto-market-value">
                <h2>Valor de mercado</h2>
                <p class="market-description">
                    Este vehículo se comparó con otros @Model.ToTitleCase(Model.Vehicle.Marca) @Model.ToTitleCase(Model.Vehicle.Modelo) @Model.Vehicle.Ano en AutoClick.cr, considerando precio, kilometraje, equipamiento y estado.
                </p>

                <div class="market-chart">
                    <div class="market-indicator">
                        <div class="market-price-indicator">
                            <div class="indicator-arrow"></div>
                            <div class="price-info">
                                <h3>@Model.FormatPrice(Model.Vehicle.ValorFiscal)</h3>
                                <div class="market-status">@Model.GetMarketStatus()</div>
                                <div class="market-difference">Precio competitivo</div>
                            </div>
                        </div>

                        <div class="average-value">
                            <div class="average-arrow"></div>
                            <div class="average-text">Valor promedio<br />@Model.FormatPrice(Model.GetMarketValue())</div>
                        </div>
                    </div>
                </div>

                <p class="market-powered">Impulsado por AutoClick.cr</p>
            </section>
        }

        <!-- Financing Calculator Section -->
        <section class="producto-financing">
            <h2>CALCULAR FINANCIAMIENTO</h2>
            
            <form method="get" class="financing-form">
                <input type="hidden" name="id" value="@Model.Id" />
                
                <div class="financing-row">
                    <div class="financing-field">
                        <label for="currency">Moneda *</label>
                        <select name="currency" id="currency" class="financing-select">
                            <option value="USD" selected="@(Model.Currency == "USD")">Dólar (USD)</option>
                            <option value="CRC" selected="@(Model.Currency == "CRC")">Colones (CRC)</option>
                        </select>
                    </div>
                    
                    <div class="financing-field">
                        <label for="vehiclePrice">Precio total del vehículo *</label>
                        <input type="text" name="vehiclePrice" id="vehiclePrice" value="@Model.FormatPrice(Model.VehiclePrice)" class="financing-input" readonly />
                    </div>
                </div>
                
                <div class="financing-row">
                    <div class="financing-field">
                        <label for="loanTerm">Plazo del préstamo *</label>
                        <select name="loanTerm" id="loanTerm" class="financing-select">
                            <option value="84" selected="@(Model.LoanTerm == 84)">84 meses</option>
                            <option value="72" selected="@(Model.LoanTerm == 72)">72 meses</option>
                            <option value="60" selected="@(Model.LoanTerm == 60)">60 meses</option>
                            <option value="48" selected="@(Model.LoanTerm == 48)">48 meses</option>
                        </select>
                    </div>
                    
                    <div class="financing-field">
                        <label for="downPayment">Prima deseada</label>
                        <input type="number" name="downPayment" id="downPayment" value="@Model.DownPayment" placeholder="Mínimo $10,000" class="financing-input" />
                    </div>
                </div>
                
                <div class="financing-row">
                    <div class="financing-field">
                        <label for="annualRate">Tasa anual</label>
                        <input type="text" name="annualRate" id="annualRate" value="8.5%" class="financing-input" readonly />
                    </div>
                    
                    <div class="financing-field">
                        <label for="monthlyPayment"><strong>Cuota mensual estimada</strong></label>
                        <input type="text" id="monthlyPayment" value="@Model.FormatPrice(Model.MonthlyPayment)" readonly class="financing-result" />
                    </div>
                </div>
                
                <button type="button" class="financing-submit-btn" onclick="solicitarPreAprobacion()">Solicitar pre-aprobación</button>
            </form>
        </section>


        <!-- Similar Cars Section -->
        <section class="producto-similar-cars">
            <div class="similar-cars-header">
                <h2>Vehículos similares</h2>
                <a href="#" class="see-all-link">Ver todo</a>
            </div>
            
            <div class="similar-cars-grid">
                @foreach (var auto in Model.SimilarAutos)
                {
                    <div class="similar-car-card" onclick="window.location.href='@Url.Page("/Producto", new { id = auto.Id })'" style="cursor: pointer;">
                        @if (!string.IsNullOrEmpty(auto.ImagenPrincipal))
                        {
                            <img src="@auto.ImagenPrincipal" alt="@auto.NombreCompleto" class="similar-car-image" style="object-fit: contain;" />
                        }
                        <div class="similar-car-info">
                            <h3 class="similar-car-title">@auto.NombreCompleto</h3>
                            <p class="similar-car-price">@auto.ValorFiscalFormateado</p>
                        </div>
                        <div class="similar-car-actions">
                            <button class="similar-favorite-btn" onclick="event.stopPropagation();">
                                <div class="heart-outline"></div>
                            </button>
                            <button class="similar-share-btn" onclick="event.stopPropagation();">
                                <div class="share-outline"></div>
                            </button>
                        </div>
                    </div>
                }
            </div>
        </section>

    </div>

    <!-- Footer -->
    <partial name="_Footer" />
</div>

<script>
// Gallery navigation
document.addEventListener('DOMContentLoaded', function() {
    // Thumbnail click functionality
    const thumbnails = document.querySelectorAll('.thumbnail-item');
    const mainImage = document.querySelector('.main-car-image');
    
    thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', function() {
            // Remove active class from all thumbnails
            thumbnails.forEach(t => t.classList.remove('active'));
            // Add active class to clicked thumbnail
            this.classList.add('active');
            
            // Update main image (in a real app, you'd have different images)
            if (index < 7) { // Not the "more images" thumbnail
                // Update main image src here
            }
        });
    });
    
    // Financing calculator auto-update (excluding readonly fields)
    const financingInputs = document.querySelectorAll('.financing-input:not([readonly]), .financing-select');
    financingInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Auto-submit form to recalculate
            this.closest('form').submit();
        });
    });
});

// Function for pre-approval button
function solicitarPreAprobacion() {
    // Get form data
    const vehiculo = '@Html.Raw((Model.Vehicle?.NombreCompleto ?? "Vehículo").Replace("'", "\\'"))';
    const precio = document.getElementById('vehiclePrice').value;
    const plazo = document.getElementById('loanTerm').value;
    const prima = document.getElementById('downPayment').value || '0';
    
    // Build URL with parameters
    const params = new URLSearchParams({
        vehiculo: vehiculo,
        precio: precio,
        plazo: plazo,
        prima: prima
    });
    
    // Redirect to bank landing page
    window.location.href = '/LandingBanco?' + params.toString();
}
</script>

