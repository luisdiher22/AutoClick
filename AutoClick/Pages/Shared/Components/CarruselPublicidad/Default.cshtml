@model AutoClick.ViewComponents.CarruselPublicidadViewModel

@{
    var claseContenedor = Model.Formato switch
    {
        "horizontal" => "ad-carousel-horizontal",
        "medio-vertical" => "ad-carousel-medio-vertical",
        _ => "ad-carousel-cuadrado"
    };
}

<div class="@claseContenedor" data-seccion="@Model.Seccion">
    <div class="ad-carousel-wrapper">
        @if (!Model.Anuncios.Any())
        {
            <!-- Solo placeholder cuando no hay anuncios -->
            <div class="ad-carousel-item ad-placeholder" onclick="abrirModalSolicitudAnuncio()">
                <div class="placeholder-content">
                    <img src="/images/logos/logo-autoclick-white.png" alt="AutoClick" class="placeholder-logo" />
                    <p class="placeholder-title">SU ANUNCIO AQUÍ</p>
                    <p class="placeholder-subtitle">¡Haga click en este recuadro para empezar!</p>
                </div>
            </div>
        }
        else
        {
            <!-- Anuncios reales -->
            @foreach (var anuncio in Model.Anuncios)
            {
                <div class="ad-carousel-item" data-anuncio-id="@anuncio.Id">
                    @if (!string.IsNullOrEmpty(anuncio.UrlDestino))
                    {
                        <a href="@anuncio.UrlDestino" target="_blank" rel="noopener noreferrer" 
                           onclick="registrarClickAnuncio(@anuncio.Id); return true;" class="ad-link">
                            <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" />
                        </a>
                    }
                    else
                    {
                        <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" 
                             onclick="registrarVistaAnuncio(@anuncio.Id)" />
                    }
                </div>
            }
            
            <!-- Placeholder "SU ANUNCIO AQUÍ" al final del carrusel -->
            <div class="ad-carousel-item ad-placeholder" onclick="abrirModalSolicitudAnuncio()">
                <div class="placeholder-content">
                    <img src="/images/logos/logo-autoclick-white.png" alt="AutoClick" class="placeholder-logo" />
                    <p class="placeholder-title">SU ANUNCIO AQUÍ</p>
                    <p class="placeholder-subtitle">¡Haga click en este recuadro para empezar!</p>
                </div>
            </div>
        }
    </div>

    @if (Model.Anuncios.Count >= 1)
    {
        <!-- Controles del carrusel (solo si hay al menos 1 anuncio + placeholder) -->
        <button class="ad-carousel-prev" onclick="cambiarAnuncio(this, -1)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <button class="ad-carousel-next" onclick="cambiarAnuncio(this, 1)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    }
</div>

<style>
    .ad-carousel-cuadrado, .ad-carousel-horizontal {
        position: relative;
        width: 100%;
        overflow: hidden;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.05);
    }

    .ad-carousel-cuadrado {
        width: 100%;
        max-width: 344px;
        height: 100%;
        min-height: 423px;
    }

    /* Anuncios cuadrados en Producto sidebar - 560px de ancho */
    .ad-carousel-cuadrado[data-seccion="producto-sidebar-1"],
    .ad-carousel-cuadrado[data-seccion="producto-sidebar-2"] {
        max-width: 560px !important;
        width: 560px !important;
        min-height: 688px !important;
    }

    /* Asegurar que el contenido cubra todo el ancho y alto */
    .ad-carousel-cuadrado .ad-carousel-wrapper,
    .ad-carousel-cuadrado .ad-carousel-item,
    .ad-carousel-cuadrado .placeholder-content {
        width: 100% !important;
        height: 100% !important;
        min-height: inherit;
    }

    /* Asegurar altura mínima para MisAnuncios y BusquedaAvanzada */
    .ad-carousel-cuadrado[data-seccion="busqueda-sidebar"] .ad-carousel-wrapper,
    .ad-carousel-cuadrado[data-seccion="mis-anuncios-sidebar"] .ad-carousel-wrapper {
        min-height: 423px !important;
    }

    .ad-carousel-cuadrado[data-seccion="busqueda-sidebar"] .ad-carousel-item,
    .ad-carousel-cuadrado[data-seccion="mis-anuncios-sidebar"] .ad-carousel-item,
    .ad-carousel-cuadrado[data-seccion="busqueda-sidebar"] .placeholder-content,
    .ad-carousel-cuadrado[data-seccion="mis-anuncios-sidebar"] .placeholder-content {
        min-height: 423px !important;
    }

    .ad-carousel-cuadrado .ad-carousel-item .ad-image,
    .ad-carousel-cuadrado .ad-carousel-item .ad-link {
        width: 100% !important;
        height: 100% !important;
    }

    .ad-carousel-horizontal {
        width: 100%;
        max-width: 1010px;
        height: 189px;
        margin: 0 auto;
    }

    /* Estilos específicos para anuncios horizontales en diferentes secciones */
    .ad-carousel-horizontal[data-seccion="busqueda-banner"],
    .ad-carousel-horizontal[data-seccion="busqueda-footer"] {
        max-width: 100%;
    }

    .ad-carousel-horizontal[data-seccion="guardados-footer"] {
        max-width: 100%;
    }

    .ad-carousel-horizontal[data-seccion="mis-anuncios-footer"] {
        max-width: 100%;
    }

    .ad-carousel-medio-vertical {
        width: 100%;
        max-width: 401px;
        height: 287px;
    }

    .ad-carousel-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        transition: transform 0.5s ease-in-out;
    }

    .ad-carousel-item {
        min-width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .ad-carousel-item .ad-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        cursor: pointer;
        display: block;
    }

    /* Imágenes en carruseles cuadrados usan cover para llenar el espacio */
    .ad-carousel-cuadrado .ad-carousel-item .ad-image,
    .ad-carousel-cuadrado .ad-carousel-item .ad-link img {
        object-fit: cover;
    }

    .ad-carousel-item .ad-link {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ad-carousel-item .ad-link img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .ad-placeholder {
        background: rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .ad-placeholder:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .placeholder-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
        padding: 35px;
        width: 100%;
        height: 100%;
    }

    .placeholder-content.horizontal {
        gap: 15px;
    }

    .placeholder-logo {
        max-width: 140px;
        height: auto;
    }

    .placeholder-content.horizontal .placeholder-logo {
        max-width: 170px;
    }

    .placeholder-title {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        font-size: 24px;
        color: white;
        text-align: center;
        text-shadow: 0px 2.5px 2.5px rgba(0, 0, 0, 0.5);
        margin: 0;
        white-space: nowrap;
    }

    .placeholder-content.horizontal .placeholder-title {
        font-size: 34px;
        text-shadow: 0px 4.3px 4.3px rgba(0, 0, 0, 0.5);
    }

    .placeholder-subtitle {
        font-family: 'Montserrat', sans-serif;
        font-weight: 500;
        font-size: 24px;
        color: white;
        text-align: center;
        text-shadow: 0px 2.5px 2.5px rgba(0, 0, 0, 0.5);
        margin: 0;
        max-width: 275px;
        line-height: 1.2;
    }

    .placeholder-content.horizontal .placeholder-subtitle {
        font-size: 23px;
        text-shadow: 0px 4.3px 4.3px rgba(0, 0, 0, 0.5);
        max-width: 100%;
        white-space: nowrap;
    }

    .ad-carousel-prev, .ad-carousel-next {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: background 0.3s ease;
    }

    .ad-carousel-prev:hover, .ad-carousel-next:hover {
        background: rgba(0, 0, 0, 0.7);
    }

    .ad-carousel-prev {
        left: 10px;
    }

    .ad-carousel-next {
        right: 10px;
    }

    .ad-carousel-indicators {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .ad-carousel-indicators .indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .ad-carousel-indicators .indicator.active {
        background: white;
    }

    .ad-carousel-indicators .indicator:hover {
        background: rgba(255, 255, 255, 0.8);
    }
</style>

<script>
    let currentIndex = 0;
    const autoplayInterval = 5000; // 5 segundos
    let autoplayTimer = null;

    function cambiarAnuncio(button, direccion) {
        const carrusel = button.closest('.ad-carousel-cuadrado, .ad-carousel-horizontal');
        const wrapper = carrusel.querySelector('.ad-carousel-wrapper');
        const items = wrapper.querySelectorAll('.ad-carousel-item');
        const indicators = carrusel.querySelectorAll('.indicator');
        
        currentIndex += direccion;
        
        if (currentIndex < 0) {
            currentIndex = items.length - 1;
        } else if (currentIndex >= items.length) {
            currentIndex = 0;
        }
        
        wrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
        
        indicators.forEach((ind, idx) => {
            ind.classList.toggle('active', idx === currentIndex);
        });

        resetAutoplay(carrusel);
    }

    function irAAnuncio(carrusel, index) {
        const wrapper = carrusel.querySelector('.ad-carousel-wrapper');
        const items = wrapper.querySelectorAll('.ad-carousel-item');
        const indicators = carrusel.querySelectorAll('.indicator');
        
        if (index >= 0 && index < items.length) {
            currentIndex = index;
            wrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
            
            indicators.forEach((ind, idx) => {
                ind.classList.toggle('active', idx === currentIndex);
            });

            resetAutoplay(carrusel);
        }
    }

    function resetAutoplay(carrusel) {
        if (autoplayTimer) {
            clearInterval(autoplayTimer);
        }
        
        autoplayTimer = setInterval(() => {
            const nextBtn = carrusel.querySelector('.ad-carousel-next');
            if (nextBtn) {
                cambiarAnuncio(nextBtn, 1);
            }
        }, autoplayInterval);
    }

    async function registrarClickAnuncio(anuncioId) {
        try {
            await fetch('/api/publicidad/registrar-click', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ anuncioId: anuncioId })
            });
        } catch (error) {
            console.error('Error al registrar click:', error);
        }
    }

    async function registrarVistaAnuncio(anuncioId) {
        try {
            await fetch('/api/publicidad/registrar-vista', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ anuncioId: anuncioId })
            });
        } catch (error) {
            console.error('Error al registrar vista:', error);
        }
    }

    function abrirModalSolicitudAnuncio() {
        // La función está definida en _Layout.cshtml
        if (typeof window.abrirModalSolicitudAnuncio === 'undefined') {
            console.warn('Modal de solicitud de anuncio no disponible. Redirigiendo a página de anunciar empresa.');
            window.location.href = '/anunciar-empresa';
        }
    }

    // Inicializar autoplay cuando carga la página
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.ad-carousel-cuadrado, .ad-carousel-horizontal').forEach(carrusel => {
            const items = carrusel.querySelectorAll('.ad-carousel-item');
            if (items.length > 1) {
                resetAutoplay(carrusel);
            }

            // Agregar event listeners a los indicadores
            carrusel.querySelectorAll('.indicator').forEach((indicator, index) => {
                indicator.addEventListener('click', () => {
                    irAAnuncio(carrusel, index);
                });
            });
        });
    });
</script>
