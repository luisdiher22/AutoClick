@model AutoClick.ViewComponents.CarruselPublicidadViewModel

@{
    var claseContenedor = Model.Formato switch
    {
        "horizontal" => "ad-carousel-horizontal",
        "medio-vertical" => "ad-carousel-medio-vertical",
        _ => "ad-carousel-cuadrado"
    };
}

<div class="ad-carousel-container @claseContenedor" data-seccion="@Model.Seccion">
    <div class="ad-carousel-inner">
        <div class="ad-carousel-wrapper">
            @if (!Model.Anuncios.Any())
            {
                <!-- Solo placeholder cuando no hay anuncios -->
                <div class="ad-carousel-item ad-placeholder" onclick="abrirModalSolicitudAnuncio()">
                    @if (Model.Formato == "horizontal")
                    {
                        <picture>
                            <source media="(max-width: 768px)" 
                                    srcset="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderHorizontal_movil.png">
                            <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderHorizontal_escritorio.png" 
                                 alt="Su anuncio aquí" class="placeholder-image" />
                        </picture>
                    }
                    else
                    {
                        <picture>
                            <source media="(max-width: 768px)" 
                                    srcset="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderCuadrado_movil.png">
                            <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderCuadrado_escritorio.png" 
                                 alt="Su anuncio aquí" class="placeholder-image" />
                        </picture>
                    }
                </div>
            }
            else
            {
                <!-- Anuncios reales -->
                @foreach (var anuncio in Model.Anuncios)
                {
                    <div class="ad-carousel-item" data-anuncio-id="@anuncio.Id">
                        @if (!string.IsNullOrEmpty(anuncio.UrlDestino))
                        {
                            <a href="@anuncio.UrlDestino" target="_blank" rel="noopener noreferrer" 
                               onclick="registrarClickAnuncio(@anuncio.Id); return true;" class="ad-link">
                                <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" />
                            </a>
                        }
                        else
                        {
                            <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" 
                                 onclick="registrarVistaAnuncio(@anuncio.Id)" />
                        }
                    </div>
                }
                
                <!-- Placeholder "SU ANUNCIO AQUÍ" al final del carrusel -->
                <div class="ad-carousel-item ad-placeholder" onclick="abrirModalSolicitudAnuncio()">
                    @if (Model.Formato == "horizontal")
                    {
                        <picture>
                            <source media="(max-width: 768px)" 
                                    srcset="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderHorizontal_movil.png">
                            <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderHorizontal_escritorio.png" 
                                 alt="Su anuncio aquí" class="placeholder-image" />
                        </picture>
                    }
                    else
                    {
                        <picture>
                            <source media="(max-width: 768px)" 
                                    srcset="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderCuadrado_movil.png">
                            <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderCuadrado_escritorio.png" 
                                 alt="Su anuncio aquí" class="placeholder-image" />
                        </picture>
                    }
                </div>
            }
        </div>

        @if (Model.Anuncios.Count >= 1)
        {
            <!-- Controles del carrusel (dentro del inner para posicionamiento correcto) -->
            <button class="ad-carousel-prev" onclick="cambiarAnuncio(this, -1)">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <circle cx="16" cy="16" r="16" fill="rgba(0, 0, 0, 0.3)" />
                    <path d="M18 10L12 16L18 22" stroke="white" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
            <button class="ad-carousel-next" onclick="cambiarAnuncio(this, 1)">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <circle cx="16" cy="16" r="16" fill="rgba(0, 0, 0, 0.3)" />
                    <path d="M14 10L20 16L14 22" stroke="white" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>
        }
    </div>
</div>

<style>
    /* ===== CONTENEDOR EXTERIOR (SIN OVERFLOW) ===== */
    .ad-carousel-container {
        position: relative;
        width: 100%;
    }

    /* ===== CONTENEDOR INNER (POSICIONAMIENTO) ===== */
    .ad-carousel-inner {
        position: relative;
        overflow: hidden;
        border-radius: 4px;
        background: #02081C;
    }

    /* ===== CONTENEDORES BASE ===== */
    .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
        position: relative;
        width: 100%;
    }

    /* ===== ANUNCIOS CUADRADOS ===== */
    .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner {
        max-width: 344px;
        aspect-ratio: 344 / 423;
        min-height: 250px;
        max-height: 423px;
        margin: 0 auto;
    }

    /* Anuncios cuadrados en Producto sidebar - ocupan 100% del ancho del contenedor */
    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-1"],
    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-2"] {
        width: 100% !important;
        max-width: none !important;
    }

    /* Agregar espacio después del primer anuncio */
    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-1"] {
        margin-bottom: 250px !important;
    }

    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-1"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-2"] .ad-carousel-inner {
        max-width: 100% !important;
        width: 100% !important;
        aspect-ratio: 560 / 688 !important;
        min-height: 400px !important;
        max-height: 688px !important;
        margin: 0 !important;
    }

    /* ===== ANUNCIOS HORIZONTALES ===== */
    .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner {
        max-width: 1010px;
        aspect-ratio: 1010 / 189;
        min-height: 120px;
        max-height: 189px;
        margin: 0 auto;
    }

    /* Anuncios horizontales que deben ocupar 100% del ancho */
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="busqueda-banner"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="busqueda-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="guardados-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="mis-anuncios-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="destacados-banner"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="destacados-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="explorar-banner-1"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="explorar-banner-2"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="perfil-agencia-banner"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="recien-vistos-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="reportar-problema-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="rainx-faq-footer"] .ad-carousel-inner {
        max-width: 100%;
    }

    /* ===== ANUNCIOS MEDIO VERTICAL ===== */
    .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
        max-width: 401px;
        aspect-ratio: 401 / 287;
        min-height: 200px;
        max-height: 287px;
    }

    /* ===== ESTRUCTURA INTERNA ===== */
    .ad-carousel-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        transition: transform 0.5s ease-in-out;
    }

    .ad-carousel-item {
        min-width: 100%;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
    }

    /* ===== IMÁGENES - SIEMPRE CONTENIDAS ===== */
    .ad-carousel-item .ad-image,
    .ad-carousel-item .ad-link,
    .ad-carousel-item .ad-link img,
    .placeholder-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }

    .ad-carousel-item .ad-image {
        cursor: pointer;
    }

    /* ===== PLACEHOLDER ===== */
    .ad-placeholder {
        background: transparent;
        cursor: pointer;
        transition: opacity 0.3s ease;
    }

    .ad-placeholder:hover {
        opacity: 0.9;
    }

    /* ===== RESPONSIVE - TABLET (≤102px) ===== */
    @@media (max-width: 1024px) {
        /* Reducir tamaños máximos pero mantener aspect ratios */
        .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner {
            max-width: 300px;
            min-height: 220px;
            max-height: 370px;
        }

        .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-1"] .ad-carousel-inner,
        .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-2"] .ad-carousel-inner {
            max-width: 100%;
            min-height: 350px;
            max-height: 600px;
        }

        .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner {
            min-height: 100px;
            max-height: 150px;
        }

        .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
            max-width: 350px;
            min-height: 180px;
            max-height: 250px;
        }
    }

    /* ===== RESPONSIVE - MÓVIL (≤768px) ===== */
    @@media (max-width: 768px) {
        /* Ajustar para pantallas móviles */
        .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner {
            max-width: 100%;
            aspect-ratio: 1 / 1;
            min-height: 250px;
            max-height: 400px;
        }

        .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-1"] .ad-carousel-inner,
        .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-2"] .ad-carousel-inner {
            aspect-ratio: 1 / 1;
            min-height: 250px;
            max-height: 450px;
        }

        .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner {
            aspect-ratio: 16 / 9;
            min-height: 120px;
            max-height: 200px;
        }

        .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
            max-width: 100%;
            aspect-ratio: 4 / 3;
            min-height: 180px;
            max-height: 280px;
        }
    }

    /* ===== RESPONSIVE - MÓVIL PEQUEÑO (≤480px) ===== */
    @@media (max-width: 480px) {
        .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner {
            min-height: 200px;
            max-height: 300px;
        }

        .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-1"] .ad-carousel-inner,
        .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-2"] .ad-carousel-inner {
            min-height: 200px;
            max-height: 320px;
        }

        .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner {
            min-height: 100px;
            max-height: 150px;
        }

        .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
            min-height: 150px;
            max-height: 220px;
        }
    }

    .ad-carousel-prev, .ad-carousel-next {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 15;
        transition: opacity 0.2s ease, transform 0.2s ease;
        padding: 0;
        opacity: 0.6;
    }

    .ad-carousel-prev:hover, .ad-carousel-next:hover {
        opacity: 1;
        transform: translateY(-50%) scale(1.1);
    }

    .ad-carousel-prev {
        left: 8px;
    }

    .ad-carousel-next {
        right: 8px;
    }

    .ad-carousel-indicators {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .ad-carousel-indicators .indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .ad-carousel-indicators .indicator.active {
        background: white;
    }

    .ad-carousel-indicators .indicator:hover {
        background: rgba(255, 255, 255, 0.8);
    }
</style>

<script>
    // Evitar redeclaración si el script se incluye múltiples veces
    if (typeof window.carouselAutoplayInterval === 'undefined') {
        window.carouselAutoplayInterval = 5000; // 5 segundos
    }
    if (typeof window.carouselStates === 'undefined') {
        window.carouselStates = new Map(); // Almacena el estado de cada carrusel
    }

    const autoplayInterval = window.carouselAutoplayInterval;
    const carouselStates = window.carouselStates;

    function getCarouselState(carrusel) {
        if (!carouselStates.has(carrusel)) {
            carouselStates.set(carrusel, {
                currentIndex: 0,
                autoplayTimer: null
            });
        }
        return carouselStates.get(carrusel);
    }

    function cambiarAnuncio(button, direccion) {
        const carrusel = button.closest('.ad-carousel-inner');
        const wrapper = carrusel.querySelector('.ad-carousel-wrapper');
        const items = wrapper.querySelectorAll('.ad-carousel-item');
        const indicators = carrusel.querySelectorAll('.indicator');
        const state = getCarouselState(carrusel);
        
        state.currentIndex += direccion;
        
        if (state.currentIndex < 0) {
            state.currentIndex = items.length - 1;
        } else if (state.currentIndex >= items.length) {
            state.currentIndex = 0;
        }
        
        wrapper.style.transform = `translateX(-${state.currentIndex * 100}%)`;
        
        indicators.forEach((ind, idx) => {
            ind.classList.toggle('active', idx === state.currentIndex);
        });

        resetAutoplay(carrusel);
    }

    function irAAnuncio(carrusel, index) {
        const wrapper = carrusel.querySelector('.ad-carousel-wrapper');
        const items = wrapper.querySelectorAll('.ad-carousel-item');
        const indicators = carrusel.querySelectorAll('.indicator');
        const state = getCarouselState(carrusel);
        
        if (index >= 0 && index < items.length) {
            state.currentIndex = index;
            wrapper.style.transform = `translateX(-${state.currentIndex * 100}%)`;
            
            indicators.forEach((ind, idx) => {
                ind.classList.toggle('active', idx === state.currentIndex);
            });

            resetAutoplay(carrusel);
        }
    }

    function resetAutoplay(carrusel) {
        const state = getCarouselState(carrusel);
        
        if (state.autoplayTimer) {
            clearInterval(state.autoplayTimer);
        }
        
        state.autoplayTimer = setInterval(() => {
            const nextBtn = carrusel.querySelector('.ad-carousel-next');
            if (nextBtn) {
                cambiarAnuncio(nextBtn, 1);
            }
        }, autoplayInterval);
    }

    async function registrarClickAnuncio(anuncioId) {
        try {
            await fetch('/api/publicidad/registrar-click', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ anuncioId: anuncioId })
            });
        } catch (error) {
            console.error('Error al registrar click:', error);
        }
    }

    async function registrarVistaAnuncio(anuncioId) {
        try {
            await fetch('/api/publicidad/registrar-vista', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ anuncioId: anuncioId })
            });
        } catch (error) {
            console.error('Error al registrar vista:', error);
        }
    }

    function abrirModalSolicitudAnuncio() {
        // La función está definida en _Layout.cshtml
        if (typeof window.abrirModalSolicitudAnuncio === 'undefined') {
            console.warn('Modal de solicitud de anuncio no disponible. Redirigiendo a página de anunciar empresa.');
            window.location.href = '/anunciar-empresa';
        }
    }

    // Inicializar autoplay cuando carga la página
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.ad-carousel-inner').forEach(carrusel => {
            const items = carrusel.querySelectorAll('.ad-carousel-item');
            if (items.length > 1) {
                resetAutoplay(carrusel);
            }

            // Agregar event listeners a los indicadores
            carrusel.querySelectorAll('.indicator').forEach((indicator, index) => {
                indicator.addEventListener('click', () => {
                    irAAnuncio(carrusel, index);
                });
            });
        });
    });
</script>
