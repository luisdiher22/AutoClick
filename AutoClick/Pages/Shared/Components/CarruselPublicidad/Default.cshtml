@model AutoClick.ViewComponents.CarruselPublicidadViewModel
@using AutoClick.Models

@{
    var claseContenedor = Model.Formato switch
    {
        "horizontal" => "ad-carousel-horizontal",
        "medio-vertical" => "ad-carousel-medio-vertical",
        _ => "ad-carousel-cuadrado"
    };

    // Agrupar anuncios por tipo de dispositivo
    var anunciosDesktop = Model.Anuncios.Where(a => a.Tamano.GetDeviceType() == "Desktop").ToList();
    var anunciosTablet = Model.Anuncios.Where(a => a.Tamano.GetDeviceType() == "Tablet").ToList();
    var anunciosMovil = Model.Anuncios.Where(a => a.Tamano.GetDeviceType() == "Móvil").ToList();
    
    // Debug: Contar anuncios por dispositivo
    var totalAnuncios = Model.Anuncios.Count;
    var debugInfo = $"Total: {totalAnuncios} | Desktop: {anunciosDesktop.Count} | Tablet: {anunciosTablet.Count} | Móvil: {anunciosMovil.Count}";
}

<div class="ad-carousel-container @claseContenedor" data-seccion="@Model.Seccion" data-debug="@debugInfo">
    <div class="ad-carousel-inner">
        <!-- CARRUSEL DESKTOP -->
        <div class="ad-carousel-wrapper ad-carousel-desktop" data-device="desktop" data-count="@anunciosDesktop.Count">
            @foreach (var anuncio in anunciosDesktop)
            {
                <div class="ad-carousel-item" data-anuncio-id="@anuncio.Id">
                    @if (!string.IsNullOrEmpty(anuncio.UrlDestino))
                    {
                        <a href="@anuncio.UrlDestino" target="_blank" rel="noopener noreferrer" 
                           onclick="window.registrarClickAnuncio(@anuncio.Id); return true;" class="ad-link">
                            <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" />
                        </a>
                    }
                    else
                    {
                        <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" 
                             onclick="window.registrarVistaAnuncio(@anuncio.Id)" />
                    }
                </div>
            }
            
            <!-- Placeholder SIEMPRE al final (desktop) -->
            <div class="ad-carousel-item ad-placeholder" onclick="window.abrirModalSolicitudAnuncioPublicidad()">
                @if (Model.Formato == "horizontal")
                {
                    <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderHorizontal_escritorio.png" 
                         alt="Su anuncio aquí" class="placeholder-image" />
                }
                else
                {
                    <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderCuadrado_escritorio.png" 
                         alt="Su anuncio aquí" class="placeholder-image" />
                }
            </div>
        </div>

        <!-- CARRUSEL TABLET -->
        <div class="ad-carousel-wrapper ad-carousel-tablet" data-device="tablet" data-count="@anunciosTablet.Count">
            @foreach (var anuncio in anunciosTablet)
            {
                <div class="ad-carousel-item" data-anuncio-id="@anuncio.Id">
                    @if (!string.IsNullOrEmpty(anuncio.UrlDestino))
                    {
                        <a href="@anuncio.UrlDestino" target="_blank" rel="noopener noreferrer" 
                           onclick="window.registrarClickAnuncio(@anuncio.Id); return true;" class="ad-link">
                            <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" />
                        </a>
                    }
                    else
                    {
                        <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" 
                             onclick="window.registrarVistaAnuncio(@anuncio.Id)" />
                    }
                </div>
            }
            
            <!-- Placeholder SIEMPRE al final (tablet) -->
            <div class="ad-carousel-item ad-placeholder" onclick="window.abrirModalSolicitudAnuncioPublicidad()">
                @if (Model.Formato == "horizontal")
                {
                    <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderHorizontal_tablet.png" 
                         alt="Su anuncio aquí" class="placeholder-image" />
                }
                else
                {
                    <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderCuadrado_tablet.png" 
                         alt="Su anuncio aquí" class="placeholder-image" />
                }
            </div>
        </div>

        <!-- CARRUSEL MÓVIL -->
        <div class="ad-carousel-wrapper ad-carousel-mobile" data-device="mobile" data-count="@anunciosMovil.Count">
            @foreach (var anuncio in anunciosMovil)
            {
                <div class="ad-carousel-item" data-anuncio-id="@anuncio.Id">
                    @if (!string.IsNullOrEmpty(anuncio.UrlDestino))
                    {
                        <a href="@anuncio.UrlDestino" target="_blank" rel="noopener noreferrer" 
                           onclick="window.registrarClickAnuncio(@anuncio.Id); return true;" class="ad-link">
                            <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" />
                        </a>
                    }
                    else
                    {
                        <img src="@anuncio.UrlImagen" alt="Anuncio - @anuncio.EmpresaPublicidad?.NombreEmpresa" class="ad-image" 
                             onclick="window.registrarVistaAnuncio(@anuncio.Id)" />
                    }
                </div>
            }
            
            <!-- Placeholder SIEMPRE al final (móvil) -->
            <div class="ad-carousel-item ad-placeholder" onclick="window.abrirModalSolicitudAnuncioPublicidad()">
                @if (Model.Formato == "horizontal")
                {
                    <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderHorizontal_movil.png" 
                         alt="Su anuncio aquí" class="placeholder-image" />
                }
                else
                {
                    <img src="https://autoclickstorage.blob.core.windows.net/anuncios/PlaceholderCuadrado_movil.png" 
                         alt="Su anuncio aquí" class="placeholder-image" />
                }
            </div>
        </div>

        <!-- Controles del carrusel (siempre visibles) -->
        <button class="ad-carousel-prev" onclick="window.cambiarAnuncio(this, -1)">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                <circle cx="16" cy="16" r="16" fill="rgba(0, 0, 0, 0.3)" />
                <path d="M18 10L12 16L18 22" stroke="white" stroke-width="2" stroke-linecap="round" />
            </svg>
        </button>
        <button class="ad-carousel-next" onclick="window.cambiarAnuncio(this, 1)">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                <circle cx="16" cy="16" r="16" fill="rgba(0, 0, 0, 0.3)" />
                <path d="M14 10L20 16L14 22" stroke="white" stroke-width="2" stroke-linecap="round" />
            </svg>
        </button>
    </div>
</div>

<style>
    /* ===== CONTENEDOR EXTERIOR (SIN OVERFLOW) ===== */
    .ad-carousel-container {
        position: relative;
        width: 100%;
    }

    /* ===== CONTENEDOR INNER (POSICIONAMIENTO) ===== */
    .ad-carousel-inner {
        position: relative;
        overflow: hidden;
        border-radius: 4px;
        background: #02081C;
        /* Asegurar que tenga altura para los wrappers absolutos */
        min-height: 100px;
    }

    /* ===== VISIBILIDAD DE CARRUSELES POR DISPOSITIVO ===== */
    /* Todos los wrappers deben estar superpuestos en la misma posición */
    .ad-carousel-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    /* Desktop: 1024px en adelante (por defecto) */
    .ad-carousel-desktop {
        display: flex;
        z-index: 3;
    }
    .ad-carousel-tablet,
    .ad-carousel-mobile {
        display: none;
        z-index: 1;
    }

    /* Tablet: 768px hasta 1023px */
    @@media (min-width: 768px) and (max-width: 1023px) {
        .ad-carousel-desktop,
        .ad-carousel-mobile {
            display: none;
        }
        .ad-carousel-tablet {
            display: flex;
            z-index: 3;
        }
    }

    /* Móvil: hasta 767px */
    @@media (max-width: 767px) {
        .ad-carousel-desktop,
        .ad-carousel-tablet {
            display: none;
        }
        .ad-carousel-mobile {
            display: flex;
            z-index: 3;
        }
    }

    /* ===== CONTENEDORES BASE ===== */
    .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
        position: relative;
        width: 100%;
    }

    /* ===== ANUNCIOS CUADRADOS ===== */
    .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner {
        max-width: 344px;
        aspect-ratio: 344 / 423;
        margin: 0 auto;
    }

    /* Tablet: 340x373 (768px - 1023px) */
    @@media (min-width: 768px) and (max-width: 1023px) {
        .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner {
            max-width: 340px;
            aspect-ratio: 340 / 373;
        }
    }

    /* Móvil: 291x180 */
    @@media (max-width: 767px) {
        .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner {
            max-width: 291px;
            aspect-ratio: 291 / 180;
        }
    }

    /* Anuncios cuadrados en Producto sidebar - ocupan 100% del ancho del contenedor */
    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-1"],
    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-2"] {
        width: 100% !important;
        max-width: none !important;
    }

    /* Agregar espacio después del primer anuncio */
    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-1"] {
        margin-bottom: 250px !important;
    }

    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-1"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-cuadrado[data-seccion="producto-sidebar-2"] .ad-carousel-inner {
        max-width: 100% !important;
        width: 100% !important;
        aspect-ratio: 560 / 688 !important;
        margin: 0 !important;
    }

    /* ===== ANUNCIOS HORIZONTALES ===== */
    .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner {
        max-width: 1010px;
        aspect-ratio: 1010 / 189;
        margin: 0 auto;
    }

    /* Tablet: 550x217 (768px - 1023px) */
    @@media (min-width: 768px) and (max-width: 1023px) {
        .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner {
            max-width: 550px;
            aspect-ratio: 550 / 217;
        }
    }

    /* Móvil: 291x120 */
    @@media (max-width: 767px) {
        .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner {
            max-width: 291px;
            aspect-ratio: 291 / 120;
        }
    }

    /* Anuncios horizontales que deben ocupar 100% del ancho */
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="busqueda-banner"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="busqueda-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="guardados-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="mis-anuncios-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="destacados-banner"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="destacados-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="explorar-banner-1"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="explorar-banner-2"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="perfil-agencia-banner"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="recien-vistos-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="reportar-problema-footer"] .ad-carousel-inner,
    .ad-carousel-container.ad-carousel-horizontal[data-seccion="rainx-faq-footer"] .ad-carousel-inner {
        max-width: 100%;
    }

    /* ===== ANUNCIOS MEDIO VERTICAL ===== */
    .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
        max-width: 401px;
        aspect-ratio: 401 / 287;
        margin: 0 auto;
    }

    /* Tablet: 340x373 (usa el mismo aspecto que cuadrado tablet) (768px - 1023px) */
    @@media (min-width: 768px) and (max-width: 1023px) {
        .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
            max-width: 340px;
            aspect-ratio: 340 / 373;
        }
    }

    /* Móvil: 291x180 (usa el mismo aspecto que cuadrado móvil) */
    @@media (max-width: 768px) {
        .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
            max-width: 291px;
            aspect-ratio: 291 / 180;
        }
    }

    /* =/* Ya definido arriba con position: absolute */
        /* width: 100%; height: 100%; ya están definidos */per {
        width: 100%;
        height: 100%;
        display: flex;
        transition: transform 0.5s ease-in-out;
    }

    .ad-carousel-item {
        min-width: 100%;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
    }

    /* ===== IMÁGENES - SIEMPRE CONTENIDAS ===== */
    .ad-carousel-item .ad-image,
    .ad-carousel-item .ad-link,
    .ad-carousel-item .ad-link img,
    .placeholder-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }

    .ad-carousel-item .ad-image {
        cursor: pointer;
    }

    /* ===== PLACEHOLDER ===== */
    .ad-placeholder {
        background: transparent;
        cursor: pointer;
        transition: opacity 0.3s ease;
    }

    .ad-placeholder:hover {
        opacity: 0.9;
    }

    /* ===== RESPONSIVE - MANTENER PROPORCIONES EXACTAS ===== */
    @@media (max-width: 1024px) {
        /* Solo permitir que se reduzca el ancho, pero mantener aspect-ratio original */
        .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner,
        .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner,
        .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
            max-width: 100%;
        }
    }

    @@media (max-width: 768px) {
        /* Solo permitir que se reduzca el ancho, pero mantener aspect-ratio original */
        .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner,
        .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner,
        .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
            max-width: 100%;
        }
    }

    @@media (max-width: 480px) {
        /* Solo permitir que se reduzca el ancho, pero mantener aspect-ratio original */
        .ad-carousel-container.ad-carousel-cuadrado .ad-carousel-inner,
        .ad-carousel-container.ad-carousel-horizontal .ad-carousel-inner,
        .ad-carousel-container.ad-carousel-medio-vertical .ad-carousel-inner {
            max-width: 100%;
        }
    }

    .ad-carousel-prev, .ad-carousel-next {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 15;
        transition: opacity 0.2s ease, transform 0.2s ease;
        padding: 0;
        opacity: 0.6;
    }

    .ad-carousel-prev:hover, .ad-carousel-next:hover {
        opacity: 1;
        transform: translateY(-50%) scale(1.1);
    }

    .ad-carousel-prev {
        left: 8px;
    }

    .ad-carousel-next {
        right: 8px;
    }

    .ad-carousel-indicators {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .ad-carousel-indicators .indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .ad-carousel-indicators .indicator.active {
        background: white;
    }

    .ad-carousel-indicators .indicator:hover {
        background: rgba(255, 255, 255, 0.8);
    }
</style>

<script>
    // v1.0.2 - 2025-12-22 - Forzar actualización de cache
    // Evitar redeclaración si el script se incluye múltiples veces
    if (typeof window.carouselAutoplayInterval === 'undefined') {
        window.carouselAutoplayInterval = 5000; // 5 segundos
        window.carouselStates = new Map(); // Almacena el estado de cada carrusel
    }

    // Usar las variables globales directamente sin redeclarar
    if (typeof window.getCarouselState === 'undefined') {
        window.getCarouselState = function(carrusel) {
            if (!window.carouselStates.has(carrusel)) {
                window.carouselStates.set(carrusel, {
                    currentIndex: 0,
                    autoplayTimer: null
                });
            }
            return window.carouselStates.get(carrusel);
        };

        window.cambiarAnuncio = function(button, direccion) {
            const carrusel = button.closest('.ad-carousel-inner');
            // Buscar solo el wrapper visible (el que no tiene display:none)
            const wrappers = carrusel.querySelectorAll('.ad-carousel-wrapper');
            let wrapper = null;
            for (let w of wrappers) {
                if (window.getComputedStyle(w).display !== 'none') {
                    wrapper = w;
                    break;
                }
            }
            
            if (!wrapper) return;
            
            const items = wrapper.querySelectorAll('.ad-carousel-item');
            const indicators = carrusel.querySelectorAll('.indicator');
            const state = window.getCarouselState(carrusel);
            
            state.currentIndex += direccion;
            
            if (state.currentIndex < 0) {
                state.currentIndex = items.length - 1;
            } else if (state.currentIndex >= items.length) {
                state.currentIndex = 0;
            }
            
            wrapper.style.transform = `translateX(-${state.currentIndex * 100}%)`;
            
            indicators.forEach((ind, idx) => {
                ind.classList.toggle('active', idx === state.currentIndex);
            });

            window.resetAutoplay(carrusel);
        };

        window.irAAnuncio = function(carrusel, index) {
            // Buscar solo el wrapper visible
            const wrappers = carrusel.querySelectorAll('.ad-carousel-wrapper');
            let wrapper = null;
            for (let w of wrappers) {
                if (window.getComputedStyle(w).display !== 'none') {
                    wrapper = w;
                    break;
                }
            }
            
            if (!wrapper) return;
            
            const items = wrapper.querySelectorAll('.ad-carousel-item');
            const indicators = carrusel.querySelectorAll('.indicator');
            const state = window.getCarouselState(carrusel);
            
            if (index >= 0 && index < items.length) {
                state.currentIndex = index;
                wrapper.style.transform = `translateX(-${state.currentIndex * 100}%)`;
                
                indicators.forEach((ind, idx) => {
                    ind.classList.toggle('active', idx === state.currentIndex);
                });

                window.resetAutoplay(carrusel);
            }
        };

        window.resetAutoplay = function(carrusel) {
            const state = window.getCarouselState(carrusel);
            
            if (state.autoplayTimer) {
                clearInterval(state.autoplayTimer);
            }
            
            state.autoplayTimer = setInterval(() => {
                const nextBtn = carrusel.querySelector('.ad-carousel-next');
                if (nextBtn) {
                    window.cambiarAnuncio(nextBtn, 1);
                }
            }, window.carouselAutoplayInterval);
        };

        window.registrarClickAnuncio = async function(anuncioId) {
            try {
                await fetch('/api/publicidad/registrar-click', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ anuncioId: anuncioId })
                });
            } catch (error) {
                console.error('Error al registrar click:', error);
            }
        };

        window.registrarVistaAnuncio = async function(anuncioId) {
            try {
                await fetch('/api/publicidad/registrar-vista', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ anuncioId: anuncioId })
                });
            } catch (error) {
                console.error('Error al registrar vista:', error);
            }
        };

        window.abrirModalSolicitudAnuncioPublicidad = function() {
            // La función está definida en _Layout.cshtml
            if (typeof window.abrirModalSolicitudAnuncio !== 'undefined') {
                window.abrirModalSolicitudAnuncio();
            } else {
                console.warn('Modal de solicitud de anuncio no disponible. Redirigiendo a página de anunciar empresa.');
                window.location.href = '/anunciar-empresa';
            }
        };
    }

    // Inicializar carruseles (siempre se ejecuta para cada componente cargado)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function initCarousels() {
            document.querySelectorAll('.ad-carousel-inner').forEach(carrusel => {
                // Buscar el wrapper visible
                const wrappers = carrusel.querySelectorAll('.ad-carousel-wrapper');
                let wrapper = null;
                for (let w of wrappers) {
                    if (window.getComputedStyle(w).display !== 'none') {
                        wrapper = w;
                        break;
                    }
                }
                
                if (!wrapper) return;
                
                const items = wrapper.querySelectorAll('.ad-carousel-item');
                if (items.length > 1 && !window.carouselStates.has(carrusel)) {
                    window.resetAutoplay(carrusel);

                    // Agregar event listeners a los indicadores
                    carrusel.querySelectorAll('.indicator').forEach((indicator, index) => {
                        indicator.addEventListener('click', () => {
                            window.irAAnuncio(carrusel, index);
                        });
                    });
                }
            });
        });
    } else {
        // DOM ya está listo, inicializar inmediatamente
        document.querySelectorAll('.ad-carousel-inner').forEach(carrusel => {
            // Buscar el wrapper visible
            const wrappers = carrusel.querySelectorAll('.ad-carousel-wrapper');
            let wrapper = null;
            for (let w of wrappers) {
                if (window.getComputedStyle(w).display !== 'none') {
                    wrapper = w;
                    break;
                }
            }
            
            if (!wrapper) return;
            
            const items = wrapper.querySelectorAll('.ad-carousel-item');
            if (items.length > 1 && !window.carouselStates.has(carrusel)) {
                window.resetAutoplay(carrusel);

                // Agregar event listeners a los indicadores
                carrusel.querySelectorAll('.indicator').forEach((indicator, index) => {
                    indicator.addEventListener('click', () => {
                        window.irAAnuncio(carrusel, index);
                    });
                });
            }
        });
    }
</script>
